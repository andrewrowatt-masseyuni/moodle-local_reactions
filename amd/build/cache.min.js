define("local_reactions/cache",["exports"],(function(_exports){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.setMultiple=_exports.set=_exports.itemKey=_exports.isAvailable=_exports.getMultiple=_exports.get=_exports.discussionKey=void 0;let db=null,dbAttempted=!1;const getDb=()=>db?Promise.resolve(db):dbAttempted?Promise.resolve(null):(dbAttempted=!0,"undefined"==typeof indexedDB?Promise.resolve(null):new Promise((resolve=>{try{const request=indexedDB.open("local_reactions_cache",1);request.onupgradeneeded=event=>{const database=event.target.result;database.objectStoreNames.contains("reactions")||database.createObjectStore("reactions",{keyPath:"cacheKey"})},request.onsuccess=event=>{db=event.target.result,resolve(db)},request.onerror=()=>{resolve(null)},request.onblocked=()=>{resolve(null)}}catch(e){resolve(null)}})));_exports.isAvailable=async()=>null!==await getDb();_exports.itemKey=(component,itemtype,itemid)=>"".concat(component,":").concat(itemtype,":item:").concat(itemid);_exports.discussionKey=(component,itemtype,discussionid)=>"".concat(component,":").concat(itemtype,":discussion:").concat(discussionid);_exports.get=async key=>{const database=await getDb();if(!database)return null;try{return await new Promise((resolve=>{const request=database.transaction("reactions","readonly").objectStore("reactions").get(key);request.onsuccess=()=>{const record=request.result;if(record)if(Date.now()-record.timestamp>6048e5){try{database.transaction("reactions","readwrite").objectStore("reactions").delete(key)}catch(e){}resolve(null)}else resolve(record.data);else resolve(null)},request.onerror=()=>{resolve(null)}}))}catch(e){return null}};_exports.getMultiple=async keys=>{const results=new Map,database=await getDb();if(!database||!keys.length)return keys.forEach((key=>results.set(key,null))),results;try{return await new Promise((resolve=>{const store=database.transaction("reactions","readonly").objectStore("reactions"),now=Date.now();let pending=keys.length;keys.forEach((key=>{const request=store.get(key);request.onsuccess=()=>{const record=request.result;!record||now-record.timestamp>6048e5?results.set(key,null):results.set(key,record.data),pending--,0===pending&&resolve(results)},request.onerror=()=>{results.set(key,null),pending--,0===pending&&resolve(results)}}))}))}catch(e){return keys.forEach((key=>{results.has(key)||results.set(key,null)})),results}};_exports.set=async(key,data)=>{const database=await getDb();if(database)try{const tx=database.transaction("reactions","readwrite");tx.objectStore("reactions").put({cacheKey:key,data:data,timestamp:Date.now()})}catch(e){}};_exports.setMultiple=async entries=>{const database=await getDb();if(database&&entries.length)try{const store=database.transaction("reactions","readwrite").objectStore("reactions"),now=Date.now();entries.forEach((entry=>{store.put({cacheKey:entry.key,data:entry.data,timestamp:now})}))}catch(e){}}}));

//# sourceMappingURL=cache.min.js.map