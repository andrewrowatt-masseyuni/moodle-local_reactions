define("local_reactions/discussion_list_reactions",["exports","core/ajax","core/templates","core/notification","local_reactions/cache","local_reactions/utils"],(function(_exports,_ajax,_templates,_notification,Cache,_utils){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * AMD module for read-only aggregated reactions on the forum discussion list.
   *
   * Renders cached reactions instantly from IndexedDB, then refreshes from the
   * web service and animates any differences.
   *
   * @module     local_reactions/discussion_list_reactions
   * @copyright  2026 Andrew Rowatt <A.J.Rowatt@massey.ac.nz>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification),Cache=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(Cache);let config={},currentDataMap={},pollingInitialised=!1;_exports.init=cfg=>{config=cfg,loadDiscussionReactions()};const insertAfterBadges=(row,element)=>{const topicTh=row.querySelector("th.topic");if(!topicTh)return!1;const wrapperDiv=topicTh.querySelector(".p-3");if(!wrapperDiv)return!1;const badgesDiv=wrapperDiv.querySelectorAll(":scope > div")[1];return badgesDiv?badgesDiv.after(element):wrapperDiv.appendChild(element),!0},insertSkeletons=rows=>{rows.forEach((row=>{row.querySelector('[data-region="reactions-skeleton"]')||insertAfterBadges(row,(()=>{const skeleton=document.createElement("div");if(skeleton.className="local-reactions-bar local-reactions-bar-compact local-reactions-skeleton d-flex flex-wrap align-items-center",skeleton.setAttribute("data-region","reactions-skeleton"),config.compactview){const pill=document.createElement("span");pill.className="local-reactions-skeleton-pill local-reactions-skeleton-pill-compact",skeleton.appendChild(pill)}else for(let i=0;i<2;i++){const pill=document.createElement("span");pill.className="local-reactions-skeleton-pill",skeleton.appendChild(pill)}return skeleton})())}))},loadDiscussionReactions=async()=>{var _document$getElementB;const rows=document.querySelectorAll('[data-region="discussion-list-item"]');if(!rows.length)return;const discussionIds=[];if(rows.forEach((row=>{const discussionId=parseInt(row.getAttribute("data-discussionid"));discussionId&&discussionIds.push(discussionId)})),!discussionIds.length)return;const cachedDiscussionIds=new Set,cachedDataMap={},preRenderedBars=[];if(await Cache.isAvailable()){const cacheKeys=discussionIds.map((id=>Cache.discussionKey(config.component,config.itemtype,id))),cached=await Cache.getMultiple(cacheKeys);for(const discussionId of discussionIds){const key=Cache.discussionKey(config.component,config.itemtype,discussionId),cachedData=cached.get(key);if(cachedData){cachedDataMap[discussionId]=cachedData,cachedDiscussionIds.add(discussionId);try{const context=(0,_utils.buildTemplateContext)(cachedData,config.emojis,{compactview:config.compactview}),{element:barElement,js:js}=await(0,_utils.renderToElement)("local_reactions/discussion_list_reactions",context);barElement.setAttribute("data-source","cache"),preRenderedBars.push({discussionId:discussionId,barElement:barElement,js:js})}catch(err){cachedDiscussionIds.delete(discussionId),delete cachedDataMap[discussionId]}}}}null===(_document$getElementB=document.getElementById("local-reactions-reserve"))||void 0===_document$getElementB||_document$getElementB.remove();for(const{discussionId:discussionId,barElement:barElement,js:js}of preRenderedBars){const row=document.querySelector('[data-region="discussion-list-item"][data-discussionid="'.concat(discussionId,'"]'));row&&!row.querySelector('[data-region="reactions-bar"]')&&(insertAfterBadges(row,barElement),_templates.default.runTemplateJS(js))}const uncachedRows=[...rows].filter((row=>{const id=parseInt(row.getAttribute("data-discussionid"));return!cachedDiscussionIds.has(id)}));uncachedRows.length>0&&insertSkeletons(uncachedRows);try{const response=await _ajax.default.call([{methodname:"local_reactions_get_discussion_reactions",args:{component:config.component,itemtype:config.itemtype,discussionids:discussionIds,contextid:config.contextid}}])[0],reactionsMap={};response.items.forEach((item=>{reactionsMap[item.discussionid]=item}));for(const discussionId of discussionIds){const freshData=reactionsMap[discussionId]||{discussionid:discussionId,counts:[]};if(cachedDiscussionIds.has(discussionId)){const diffs=(0,_utils.computeDiffs)(cachedDataMap[discussionId],freshData);if(diffs.hasChanges)await rerenderBarWithAnimation(discussionId,freshData,diffs);else{var _row$querySelector;const row=document.querySelector('[data-region="discussion-list-item"][data-discussionid="'.concat(discussionId,'"]'));null==row||null===(_row$querySelector=row.querySelector('[data-region="reactions-bar"]'))||void 0===_row$querySelector||_row$querySelector.setAttribute("data-source","live")}}else await renderBar(discussionId,freshData,!1);currentDataMap[discussionId]=freshData}await(0,_utils.updateCacheBatch)(discussionIds,(id=>Cache.discussionKey(config.component,config.itemtype,id)),currentDataMap)}catch(err){_notification.default.exception(err)}document.querySelectorAll('[data-region="reactions-skeleton"]').forEach((el=>el.remove())),pollingInitialised||(pollingInitialised=!0,(0,_utils.createPoller)(config.pollinterval,pollDiscussionReactions))},renderBar=async(discussionId,data,fromCache)=>{const row=document.querySelector('[data-region="discussion-list-item"][data-discussionid="'.concat(discussionId,'"]'));if(!row||row.querySelector('[data-region="reactions-bar"]'))return;const context=(0,_utils.buildTemplateContext)(data,config.emojis,{compactview:config.compactview});try{const{element:barElement,js:js}=await(0,_utils.renderToElement)("local_reactions/discussion_list_reactions",context);barElement.setAttribute("data-source",fromCache?"cache":"live");const skeleton=row.querySelector('[data-region="reactions-skeleton"]');skeleton?skeleton.replaceWith(barElement):insertAfterBadges(row,barElement),_templates.default.runTemplateJS(js)}catch(err){_notification.default.exception(err)}},rerenderBarWithAnimation=async(discussionId,freshData,diffs)=>{const row=document.querySelector('[data-region="discussion-list-item"][data-discussionid="'.concat(discussionId,'"]'));if(!row)return;const existingBar=row.querySelector('[data-region="reactions-bar"]');if(!existingBar)return;const context=(0,_utils.buildTemplateContext)(freshData,config.emojis,{compactview:config.compactview});try{const{element:newBar,js:js}=await(0,_utils.renderToElement)("local_reactions/discussion_list_reactions",context);newBar.setAttribute("data-source","live"),(0,_utils.applyDiffAnimations)(newBar,diffs,config.compactview),existingBar.replaceWith(newBar),_templates.default.runTemplateJS(js),(0,_utils.clearAnimationClasses)(newBar)}catch(err){_notification.default.exception(err)}},pollDiscussionReactions=async()=>{const discussionIds=(0,_utils.collectIds)('[data-region="discussion-list-item"]',"data-discussionid");if(discussionIds.length)try{const response=await _ajax.default.call([{methodname:"local_reactions_get_discussion_reactions",args:{component:config.component,itemtype:config.itemtype,discussionids:discussionIds,contextid:config.contextid}}])[0],reactionsMap={};response.items.forEach((item=>{reactionsMap[item.discussionid]=item}));for(const discussionId of discussionIds){const freshData=reactionsMap[discussionId]||{discussionid:discussionId,counts:[]},previousData=currentDataMap[discussionId];if(previousData){const diffs=(0,_utils.computeDiffs)(previousData,freshData);diffs.hasChanges&&await rerenderBarWithAnimation(discussionId,freshData,diffs)}currentDataMap[discussionId]=freshData}await(0,_utils.updateCacheBatch)(discussionIds,(id=>Cache.discussionKey(config.component,config.itemtype,id)),currentDataMap)}catch{}}}));

//# sourceMappingURL=discussion_list_reactions.min.js.map