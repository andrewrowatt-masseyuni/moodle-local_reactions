define("local_reactions/discussion_list_reactions",["exports","core/ajax","core/templates","core/notification","local_reactions/cache"],(function(_exports,_ajax,_templates,_notification,Cache){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * AMD module for read-only aggregated reactions on the forum discussion list.
   *
   * Renders cached reactions instantly from IndexedDB, then refreshes from the
   * web service and animates any differences.
   *
   * @module     local_reactions/discussion_list_reactions
   * @copyright  2026 Andrew Rowatt <A.J.Rowatt@massey.ac.nz>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification),Cache=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(Cache);let config={};let currentDataMap={},pollTimer=null;_exports.init=cfg=>{config=cfg,loadDiscussionReactions()};const insertSkeletons=rows=>{rows.forEach((row=>{if(row.querySelector('[data-region="reactions-skeleton"]'))return;const topicTh=row.querySelector("th.topic");if(!topicTh)return;const wrapperDiv=topicTh.querySelector(".p-3");if(!wrapperDiv)return;const skeleton=(()=>{const skeleton=document.createElement("div");if(skeleton.className="local-reactions-bar local-reactions-bar-compact local-reactions-skeleton d-flex flex-wrap align-items-center",skeleton.setAttribute("data-region","reactions-skeleton"),config.compactview){const pill=document.createElement("span");pill.className="local-reactions-skeleton-pill local-reactions-skeleton-pill-compact",skeleton.appendChild(pill)}else for(let i=0;i<2;i++){const pill=document.createElement("span");pill.className="local-reactions-skeleton-pill",skeleton.appendChild(pill)}return skeleton})(),badgesDiv=wrapperDiv.querySelectorAll(":scope > div")[1];badgesDiv?badgesDiv.after(skeleton):wrapperDiv.appendChild(skeleton)}))},loadDiscussionReactions=async()=>{var _document$getElementB;const rows=document.querySelectorAll('[data-region="discussion-list-item"]');if(!rows.length)return;const discussionIds=[];if(rows.forEach((row=>{const discussionId=parseInt(row.getAttribute("data-discussionid"));discussionId&&discussionIds.push(discussionId)})),!discussionIds.length)return;const cachedDiscussionIds=new Set,cachedDataMap={},cacheAvailable=await Cache.isAvailable(),preRenderedBars=[];if(cacheAvailable){const cacheKeys=discussionIds.map((id=>Cache.discussionKey(config.component,config.itemtype,id))),cached=await Cache.getMultiple(cacheKeys);for(const discussionId of discussionIds){const key=Cache.discussionKey(config.component,config.itemtype,discussionId),cachedData=cached.get(key);if(cachedData){cachedDataMap[discussionId]=cachedData,cachedDiscussionIds.add(discussionId);try{const context=buildTemplateContext(cachedData),{html:html,js:js}=await _templates.default.renderForPromise("local_reactions/discussion_list_reactions",context),container=document.createElement("div");container.innerHTML=html;const barElement=container.firstElementChild;barElement.setAttribute("data-source","cache"),preRenderedBars.push({discussionId:discussionId,barElement:barElement,js:js})}catch(err){cachedDiscussionIds.delete(discussionId),delete cachedDataMap[discussionId]}}}}null===(_document$getElementB=document.getElementById("local-reactions-reserve"))||void 0===_document$getElementB||_document$getElementB.remove();for(const{discussionId:discussionId,barElement:barElement,js:js}of preRenderedBars){const row=document.querySelector('[data-region="discussion-list-item"][data-discussionid="'.concat(discussionId,'"]'));if(!row||row.querySelector('[data-region="reactions-bar"]'))continue;const topicTh=row.querySelector("th.topic");if(!topicTh)continue;const wrapperDiv=topicTh.querySelector(".p-3");if(!wrapperDiv)continue;const badgesDiv=wrapperDiv.querySelectorAll(":scope > div")[1];badgesDiv?badgesDiv.after(barElement):wrapperDiv.appendChild(barElement),_templates.default.runTemplateJS(js)}const uncachedRows=[...rows].filter((row=>{const id=parseInt(row.getAttribute("data-discussionid"));return!cachedDiscussionIds.has(id)}));uncachedRows.length>0&&insertSkeletons(uncachedRows);try{const response=await _ajax.default.call([{methodname:"local_reactions_get_discussion_reactions",args:{component:config.component,itemtype:config.itemtype,discussionids:discussionIds,contextid:config.contextid}}])[0],reactionsMap={};response.items.forEach((item=>{reactionsMap[item.discussionid]=item}));const cacheEntries=[];for(const discussionId of discussionIds){const freshData=reactionsMap[discussionId]||{discussionid:discussionId,counts:[]};if(cachedDiscussionIds.has(discussionId)){const diffs=computeDiffs(cachedDataMap[discussionId],freshData);if(diffs.hasChanges)await rerenderBarWithAnimation(discussionId,freshData,diffs);else{const row=document.querySelector('[data-region="discussion-list-item"][data-discussionid="'.concat(discussionId,'"]')),bar=null==row?void 0:row.querySelector('[data-region="reactions-bar"]');bar&&bar.setAttribute("data-source","live")}}else await renderBar(discussionId,freshData,!1);currentDataMap[discussionId]=freshData,cacheAvailable&&cacheEntries.push({key:Cache.discussionKey(config.component,config.itemtype,discussionId),data:{counts:freshData.counts||[]}})}cacheEntries.length>0&&await Cache.setMultiple(cacheEntries)}catch(err){_notification.default.exception(err)}document.querySelectorAll('[data-region="reactions-skeleton"]').forEach((el=>el.remove())),startPolling()},renderBar=async(discussionId,data,fromCache)=>{const row=document.querySelector('[data-region="discussion-list-item"][data-discussionid="'.concat(discussionId,'"]'));if(!row||row.querySelector('[data-region="reactions-bar"]'))return;const context=buildTemplateContext(data);try{const{html:html,js:js}=await _templates.default.renderForPromise("local_reactions/discussion_list_reactions",context),container=document.createElement("div");container.innerHTML=html;const barElement=container.firstElementChild;barElement.setAttribute("data-source",fromCache?"cache":"live");const skeleton=row.querySelector('[data-region="reactions-skeleton"]');if(skeleton)skeleton.replaceWith(barElement);else{const topicTh=row.querySelector("th.topic");if(!topicTh)return;const wrapperDiv=topicTh.querySelector(".p-3");if(!wrapperDiv)return;const badgesDiv=wrapperDiv.querySelectorAll(":scope > div")[1];badgesDiv?badgesDiv.after(barElement):wrapperDiv.appendChild(barElement)}_templates.default.runTemplateJS(js)}catch(err){_notification.default.exception(err)}},computeDiffs=(cachedData,freshData)=>{const cachedCounts={};((null==cachedData?void 0:cachedData.counts)||[]).forEach((c=>{cachedCounts[c.emoji]=c.count}));const freshCounts={};((null==freshData?void 0:freshData.counts)||[]).forEach((c=>{freshCounts[c.emoji]=c.count}));const changedEmojis=new Set,newEmojis=new Set,removedEmojis=new Set;for(const emoji of Object.keys(freshCounts))emoji in cachedCounts?freshCounts[emoji]!==cachedCounts[emoji]&&changedEmojis.add(emoji):freshCounts[emoji]>0&&newEmojis.add(emoji);for(const emoji of Object.keys(cachedCounts))cachedCounts[emoji]>0&&(!(emoji in freshCounts)||0===freshCounts[emoji])&&removedEmojis.add(emoji);return{hasChanges:changedEmojis.size>0||newEmojis.size>0||removedEmojis.size>0,changedEmojis:changedEmojis,newEmojis:newEmojis,removedEmojis:removedEmojis}},rerenderBarWithAnimation=async(discussionId,freshData,diffs)=>{const row=document.querySelector('[data-region="discussion-list-item"][data-discussionid="'.concat(discussionId,'"]'));if(!row)return;const existingBar=row.querySelector('[data-region="reactions-bar"]');if(!existingBar)return;const context=buildTemplateContext(freshData);try{const{html:html,js:js}=await _templates.default.renderForPromise("local_reactions/discussion_list_reactions",context),container=document.createElement("div");container.innerHTML=html;const newBar=container.firstElementChild;if(newBar.setAttribute("data-source","live"),config.compactview){const compactPill=newBar.querySelector(".local-reactions-pill-compact");compactPill&&compactPill.classList.add("local-reactions-count-changed")}else newBar.querySelectorAll("[data-emoji]").forEach((pill=>{const emoji=pill.getAttribute("data-emoji");diffs.changedEmojis.has(emoji)&&pill.classList.add("local-reactions-count-changed"),diffs.newEmojis.has(emoji)&&pill.classList.add("local-reactions-pill-new")}));existingBar.replaceWith(newBar),_templates.default.runTemplateJS(js),setTimeout((()=>{newBar.querySelectorAll(".local-reactions-count-changed, .local-reactions-pill-new").forEach((el=>{el.classList.remove("local-reactions-count-changed","local-reactions-pill-new")}))}),2100)}catch(err){_notification.default.exception(err)}},buildTemplateContext=data=>{const countsMap={};data.counts.forEach((c=>{countsMap[c.emoji]=c.count}));const buttons=[];let totalCount=0;const reactedEmojis=[];for(const[shortcode,unicode]of Object.entries(config.emojis)){const count=countsMap[shortcode]||0;buttons.push({shortcode:shortcode,unicode:unicode,count:count,hascount:count>0,selected:!1,canreact:!1}),count>0&&(totalCount+=count,reactedEmojis.push({unicode:unicode}))}return{buttons:buttons,canreact:!1,compactview:config.compactview,hasanycount:totalCount>0,totalcount:totalCount,reactedEmojis:reactedEmojis,selected:!1}},startPolling=()=>{!config.pollinterval||config.pollinterval<=0||pollTimer||(pollTimer=setInterval(pollDiscussionReactions,1e3*config.pollinterval),document.addEventListener("visibilitychange",(()=>{document.hidden?pollTimer&&(clearInterval(pollTimer),pollTimer=null):pollTimer||(pollDiscussionReactions(),pollTimer=setInterval(pollDiscussionReactions,1e3*config.pollinterval))})))},pollDiscussionReactions=async()=>{const rows=document.querySelectorAll('[data-region="discussion-list-item"]');if(!rows.length)return;const discussionIds=[];if(rows.forEach((row=>{const discussionId=parseInt(row.getAttribute("data-discussionid"));discussionId&&discussionIds.push(discussionId)})),discussionIds.length)try{const response=await _ajax.default.call([{methodname:"local_reactions_get_discussion_reactions",args:{component:config.component,itemtype:config.itemtype,discussionids:discussionIds,contextid:config.contextid}}])[0],reactionsMap={};response.items.forEach((item=>{reactionsMap[item.discussionid]=item}));const cacheAvailable=await Cache.isAvailable(),cacheEntries=[];for(const discussionId of discussionIds){const freshData=reactionsMap[discussionId]||{discussionid:discussionId,counts:[]},previousData=currentDataMap[discussionId];if(previousData){const diffs=computeDiffs(previousData,freshData);diffs.hasChanges&&await rerenderBarWithAnimation(discussionId,freshData,diffs)}currentDataMap[discussionId]=freshData,cacheAvailable&&cacheEntries.push({key:Cache.discussionKey(config.component,config.itemtype,discussionId),data:{counts:freshData.counts||[]}})}cacheEntries.length>0&&await Cache.setMultiple(cacheEntries)}catch{}}}));

//# sourceMappingURL=discussion_list_reactions.min.js.map