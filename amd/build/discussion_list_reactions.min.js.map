{"version":3,"file":"discussion_list_reactions.min.js","sources":["../src/discussion_list_reactions.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD module for read-only aggregated reactions on the forum discussion list.\n *\n * Renders cached reactions instantly from IndexedDB, then refreshes from the\n * web service and animates any differences.\n *\n * @module     local_reactions/discussion_list_reactions\n * @copyright  2026 Andrew Rowatt <A.J.Rowatt@massey.ac.nz>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\nimport * as Cache from 'local_reactions/cache';\nimport {\n    computeDiffs, renderToElement, buildTemplateContext, createPoller, collectIds,\n    applyDiffAnimations, clearAnimationClasses, updateCacheBatch,\n} from 'local_reactions/utils';\n\n/** @var {Object} Module-level config set during init. */\nlet config = {};\n\n/** @var {Object} Tracks last-rendered reaction data per discussion ID for diff computation during polling. */\nlet currentDataMap = {};\n\n/**\n * Initialise the discussion list reactions module.\n *\n * @param {Object} cfg Configuration from PHP.\n */\nexport const init = (cfg) => {\n    config = cfg;\n    loadDiscussionReactions();\n};\n\n/**\n * Insert an element after the badges div inside a discussion row, or append to the wrapper.\n *\n * @param {HTMLElement} row The discussion list item element.\n * @param {HTMLElement} element The element to insert.\n * @returns {boolean} Whether insertion succeeded.\n */\nconst insertAfterBadges = (row, element) => {\n    const topicTh = row.querySelector('th.topic');\n    if (!topicTh) {\n        return false;\n    }\n    const wrapperDiv = topicTh.querySelector('.p-3');\n    if (!wrapperDiv) {\n        return false;\n    }\n    const childDivs = wrapperDiv.querySelectorAll(':scope > div');\n    const badgesDiv = childDivs[1];\n    if (badgesDiv) {\n        badgesDiv.after(element);\n    } else {\n        wrapperDiv.appendChild(element);\n    }\n    return true;\n};\n\n/**\n * Create a skeleton placeholder element for a discussion list reactions bar.\n *\n * @returns {HTMLElement} The skeleton element.\n */\nconst createSkeleton = () => {\n    const skeleton = document.createElement('div');\n    skeleton.className =\n        'local-reactions-bar local-reactions-bar-compact local-reactions-skeleton d-flex flex-wrap align-items-center';\n    skeleton.setAttribute('data-region', 'reactions-skeleton');\n    if (config.compactview) {\n        const pill = document.createElement('span');\n        pill.className = 'local-reactions-skeleton-pill local-reactions-skeleton-pill-compact';\n        skeleton.appendChild(pill);\n    } else {\n        for (let i = 0; i < 2; i++) {\n            const pill = document.createElement('span');\n            pill.className = 'local-reactions-skeleton-pill';\n            skeleton.appendChild(pill);\n        }\n    }\n    return skeleton;\n};\n\n/**\n * Insert skeleton placeholders into discussion rows.\n *\n * @param {HTMLElement[]} rows The discussion list item elements.\n */\nconst insertSkeletons = (rows) => {\n    rows.forEach((row) => {\n        if (row.querySelector('[data-region=\"reactions-skeleton\"]')) {\n            return;\n        }\n        insertAfterBadges(row, createSkeleton());\n    });\n};\n\n/**\n * Remove all remaining skeleton placeholders from the page.\n */\nconst removeSkeletons = () => {\n    document.querySelectorAll('[data-region=\"reactions-skeleton\"]').forEach((el) => el.remove());\n};\n\n/**\n * Find all discussion rows on the page and load their aggregated reactions.\n *\n * Uses a cache-first strategy: renders cached counts instantly, then fetches\n * fresh data from the web service and animates any differences.\n */\nconst loadDiscussionReactions = async() => {\n    const rows = document.querySelectorAll('[data-region=\"discussion-list-item\"]');\n    if (!rows.length) {\n        return;\n    }\n\n    const discussionIds = [];\n    rows.forEach((row) => {\n        const discussionId = parseInt(row.getAttribute('data-discussionid'));\n        if (discussionId) {\n            discussionIds.push(discussionId);\n        }\n    });\n\n    if (!discussionIds.length) {\n        return;\n    }\n\n    // Phase 1: Pre-render cached bars off-DOM (all async work before any DOM mutations).\n    const cachedDiscussionIds = new Set();\n    const cachedDataMap = {};\n    const cacheAvailable = await Cache.isAvailable();\n    const preRenderedBars = [];\n\n    if (cacheAvailable) {\n        const cacheKeys = discussionIds.map((id) => Cache.discussionKey(config.component, config.itemtype, id));\n        const cached = await Cache.getMultiple(cacheKeys);\n\n        for (const discussionId of discussionIds) {\n            const key = Cache.discussionKey(config.component, config.itemtype, discussionId);\n            const cachedData = cached.get(key);\n            if (cachedData) {\n                cachedDataMap[discussionId] = cachedData;\n                cachedDiscussionIds.add(discussionId);\n                try {\n                    const context = buildTemplateContext(cachedData, config.emojis, {\n                        compactview: config.compactview,\n                    });\n                    const {element: barElement, js} = await renderToElement(\n                        'local_reactions/discussion_list_reactions', context\n                    );\n                    barElement.setAttribute('data-source', 'cache');\n                    preRenderedBars.push({discussionId, barElement, js});\n                } catch (err) {\n                    cachedDiscussionIds.delete(discussionId);\n                    delete cachedDataMap[discussionId];\n                }\n            }\n        }\n    }\n\n    // Phase 2: Synchronous DOM batch - remove reservation, insert cached bars and skeletons\n    // in one go so the browser repaints only once (no gap, no double-height).\n    document.getElementById('local-reactions-reserve')?.remove();\n\n    for (const {discussionId, barElement, js} of preRenderedBars) {\n        const row = document.querySelector(\n            `[data-region=\"discussion-list-item\"][data-discussionid=\"${discussionId}\"]`\n        );\n        if (!row || row.querySelector('[data-region=\"reactions-bar\"]')) {\n            continue;\n        }\n        insertAfterBadges(row, barElement);\n        Templates.runTemplateJS(js);\n    }\n\n    const uncachedRows = [...rows].filter((row) => {\n        const id = parseInt(row.getAttribute('data-discussionid'));\n        return !cachedDiscussionIds.has(id);\n    });\n    if (uncachedRows.length > 0) {\n        insertSkeletons(uncachedRows);\n    }\n\n    // Phase 3: Fetch fresh data from web service (for ALL discussions).\n    try {\n        const response = await Ajax.call([{\n            methodname: 'local_reactions_get_discussion_reactions',\n            args: {\n                component: config.component,\n                itemtype: config.itemtype,\n                discussionids: discussionIds,\n                contextid: config.contextid,\n            },\n        }])[0];\n\n        const reactionsMap = {};\n        response.items.forEach((item) => {\n            reactionsMap[item.discussionid] = item;\n        });\n\n        // Phase 4: Update UI and cache.\n        for (const discussionId of discussionIds) {\n            const freshData = reactionsMap[discussionId] || {discussionid: discussionId, counts: []};\n\n            if (cachedDiscussionIds.has(discussionId)) {\n                // This discussion was rendered from cache - compute diffs and re-render with animation.\n                const diffs = computeDiffs(cachedDataMap[discussionId], freshData);\n                if (diffs.hasChanges) {\n                    await rerenderBarWithAnimation(discussionId, freshData, diffs);\n                } else {\n                    // No count changes - just update data-source to live.\n                    const row = document.querySelector(\n                        `[data-region=\"discussion-list-item\"][data-discussionid=\"${discussionId}\"]`\n                    );\n                    row?.querySelector('[data-region=\"reactions-bar\"]')\n                        ?.setAttribute('data-source', 'live');\n                }\n            } else {\n                // This discussion was not cached - render normally (replaces skeleton).\n                await renderBar(discussionId, freshData, false);\n            }\n\n            currentDataMap[discussionId] = freshData;\n        }\n\n        await updateCacheBatch(\n            discussionIds,\n            (id) => Cache.discussionKey(config.component, config.itemtype, id),\n            currentDataMap,\n        );\n    } catch (err) {\n        Notification.exception(err);\n    }\n\n    removeSkeletons();\n    createPoller(config.pollinterval, pollDiscussionReactions);\n};\n\n/**\n * Build the template context and render the read-only reactions bar into a discussion row.\n *\n * @param {number} discussionId The forum discussion ID.\n * @param {Object} data Reaction data from the web service.\n * @param {boolean} fromCache Whether this render is from cached data.\n */\nconst renderBar = async(discussionId, data, fromCache) => {\n    const row = document.querySelector(\n        `[data-region=\"discussion-list-item\"][data-discussionid=\"${discussionId}\"]`\n    );\n    if (!row || row.querySelector('[data-region=\"reactions-bar\"]')) {\n        return;\n    }\n\n    const context = buildTemplateContext(data, config.emojis, {\n        compactview: config.compactview,\n    });\n\n    try {\n        const {element: barElement, js} = await renderToElement('local_reactions/discussion_list_reactions', context);\n        barElement.setAttribute('data-source', fromCache ? 'cache' : 'live');\n\n        // Replace skeleton if present, otherwise insert at the usual location.\n        const skeleton = row.querySelector('[data-region=\"reactions-skeleton\"]');\n        if (skeleton) {\n            skeleton.replaceWith(barElement);\n        } else {\n            insertAfterBadges(row, barElement);\n        }\n        Templates.runTemplateJS(js);\n    } catch (err) {\n        Notification.exception(err);\n    }\n};\n\n/**\n * Re-render a discussion reactions bar with animation for changed counts.\n *\n * @param {number} discussionId The forum discussion ID.\n * @param {Object} freshData Fresh reaction data from the web service.\n * @param {Object} diffs The diff result from computeDiffs.\n */\nconst rerenderBarWithAnimation = async(discussionId, freshData, diffs) => {\n    const row = document.querySelector(\n        `[data-region=\"discussion-list-item\"][data-discussionid=\"${discussionId}\"]`\n    );\n    if (!row) {\n        return;\n    }\n\n    const existingBar = row.querySelector('[data-region=\"reactions-bar\"]');\n    if (!existingBar) {\n        return;\n    }\n\n    const context = buildTemplateContext(freshData, config.emojis, {\n        compactview: config.compactview,\n    });\n\n    try {\n        const {element: newBar, js} = await renderToElement('local_reactions/discussion_list_reactions', context);\n        newBar.setAttribute('data-source', 'live');\n\n        applyDiffAnimations(newBar, diffs, config.compactview);\n\n        existingBar.replaceWith(newBar);\n        Templates.runTemplateJS(js);\n\n        clearAnimationClasses(newBar);\n    } catch (err) {\n        Notification.exception(err);\n    }\n};\n\n/**\n * Poll the server for updated discussion reaction data and animate any changes.\n */\nconst pollDiscussionReactions = async() => {\n    const discussionIds = collectIds('[data-region=\"discussion-list-item\"]', 'data-discussionid');\n    if (!discussionIds.length) {\n        return;\n    }\n\n    try {\n        const response = await Ajax.call([{\n            methodname: 'local_reactions_get_discussion_reactions',\n            args: {\n                component: config.component,\n                itemtype: config.itemtype,\n                discussionids: discussionIds,\n                contextid: config.contextid,\n            },\n        }])[0];\n\n        const reactionsMap = {};\n        response.items.forEach((item) => {\n            reactionsMap[item.discussionid] = item;\n        });\n\n        for (const discussionId of discussionIds) {\n            const freshData = reactionsMap[discussionId] || {discussionid: discussionId, counts: []};\n            const previousData = currentDataMap[discussionId];\n\n            if (previousData) {\n                const diffs = computeDiffs(previousData, freshData);\n                if (diffs.hasChanges) {\n                    await rerenderBarWithAnimation(discussionId, freshData, diffs);\n                }\n            }\n\n            currentDataMap[discussionId] = freshData;\n        }\n\n        await updateCacheBatch(\n            discussionIds,\n            (id) => Cache.discussionKey(config.component, config.itemtype, id),\n            currentDataMap,\n        );\n    } catch {\n        // Silently ignore poll errors to avoid disrupting the user.\n    }\n};\n"],"names":["config","currentDataMap","cfg","loadDiscussionReactions","insertAfterBadges","row","element","topicTh","querySelector","wrapperDiv","badgesDiv","querySelectorAll","after","appendChild","insertSkeletons","rows","forEach","skeleton","document","createElement","className","setAttribute","compactview","pill","i","createSkeleton","async","length","discussionIds","discussionId","parseInt","getAttribute","push","cachedDiscussionIds","Set","cachedDataMap","preRenderedBars","Cache","isAvailable","cacheKeys","map","id","discussionKey","component","itemtype","cached","getMultiple","key","cachedData","get","add","context","emojis","barElement","js","err","delete","getElementById","remove","runTemplateJS","uncachedRows","filter","has","response","Ajax","call","methodname","args","discussionids","contextid","reactionsMap","items","item","discussionid","freshData","counts","diffs","hasChanges","rerenderBarWithAnimation","renderBar","exception","el","pollinterval","pollDiscussionReactions","data","fromCache","replaceWith","existingBar","newBar","previousData"],"mappings":"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"}