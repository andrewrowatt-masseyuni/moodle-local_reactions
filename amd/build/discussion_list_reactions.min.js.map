{"version":3,"file":"discussion_list_reactions.min.js","sources":["../src/discussion_list_reactions.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD module for read-only aggregated reactions on the forum discussion list.\n *\n * @module     local_reactions/discussion_list_reactions\n * @copyright  2026 Andrew Rowatt <A.J.Rowatt@massey.ac.nz>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\n\n/** @var {Object} Module-level config set during init. */\nlet config = {};\n\n/**\n * Initialise the discussion list reactions module.\n *\n * @param {Object} cfg Configuration from PHP.\n */\nexport const init = (cfg) => {\n    config = cfg;\n    loadDiscussionReactions();\n};\n\n/**\n * Find all discussion rows on the page and load their aggregated reactions.\n */\nconst loadDiscussionReactions = async() => {\n    const rows = document.querySelectorAll('[data-region=\"discussion-list-item\"]');\n    if (!rows.length) {\n        return;\n    }\n\n    const discussionIds = [];\n    rows.forEach((row) => {\n        const discussionId = parseInt(row.getAttribute('data-discussionid'));\n        if (discussionId) {\n            discussionIds.push(discussionId);\n        }\n    });\n\n    if (!discussionIds.length) {\n        return;\n    }\n\n    try {\n        const response = await Ajax.call([{\n            methodname: 'local_reactions_get_discussion_reactions',\n            args: {\n                component: config.component,\n                itemtype: config.itemtype,\n                discussionids: discussionIds,\n                contextid: config.contextid,\n            },\n        }])[0];\n\n        const reactionsMap = {};\n        response.items.forEach((item) => {\n            reactionsMap[item.discussionid] = item;\n        });\n\n        for (const discussionId of discussionIds) {\n            const data = reactionsMap[discussionId] || {discussionid: discussionId, counts: []};\n            await renderBar(discussionId, data);\n        }\n    } catch (err) {\n        Notification.exception(err);\n    }\n};\n\n/**\n * Build the template context and render the read-only reactions bar into a discussion row.\n *\n * @param {number} discussionId The forum discussion ID.\n * @param {Object} data Reaction data from the web service.\n */\nconst renderBar = async(discussionId, data) => {\n    // Only render if there are actual reactions to show.\n    const hasAnyCount = data.counts.some((c) => c.count > 0);\n    if (!hasAnyCount) {\n        return;\n    }\n\n    const row = document.querySelector(\n        `[data-region=\"discussion-list-item\"][data-discussionid=\"${discussionId}\"]`\n    );\n    if (!row || row.querySelector('[data-region=\"reactions-bar\"]')) {\n        return;\n    }\n\n    const context = buildTemplateContext(data);\n\n    try {\n        const {html, js} = await Templates.renderForPromise('local_reactions/discussion_list_reactions', context);\n        const container = document.createElement('div');\n        container.innerHTML = html;\n        const barElement = container.firstElementChild;\n\n        // Insert below the discussion title, after the locked/timed badges div.\n        const topicTh = row.querySelector('th.topic');\n        if (!topicTh) {\n            return;\n        }\n        const wrapperDiv = topicTh.querySelector('.p-3');\n        if (!wrapperDiv) {\n            return;\n        }\n        const childDivs = wrapperDiv.querySelectorAll(':scope > div');\n        const badgesDiv = childDivs[1];\n        if (badgesDiv) {\n            badgesDiv.after(barElement);\n        } else {\n            wrapperDiv.appendChild(barElement);\n        }\n        Templates.runTemplateJS(js);\n    } catch (err) {\n        Notification.exception(err);\n    }\n};\n\n/**\n * Build Mustache template context from aggregated reaction data.\n *\n * All pills are read-only: canreact is false, selected is false for all.\n *\n * @param {Object} data Reaction data.\n * @returns {Object} Template context.\n */\nconst buildTemplateContext = (data) => {\n    const countsMap = {};\n    data.counts.forEach((c) => {\n        countsMap[c.emoji] = c.count;\n    });\n\n    const buttons = [];\n    let totalCount = 0;\n    const reactedEmojis = [];\n\n    for (const [shortcode, unicode] of Object.entries(config.emojis)) {\n        const count = countsMap[shortcode] || 0;\n        buttons.push({\n            shortcode: shortcode,\n            unicode: unicode,\n            count: count,\n            hascount: count > 0,\n            selected: false,\n            canreact: false,\n        });\n        if (count > 0) {\n            totalCount += count;\n            reactedEmojis.push({unicode: unicode});\n        }\n    }\n\n    return {\n        buttons: buttons,\n        canreact: false,\n        compactview: config.compactview,\n        hasanycount: totalCount > 0,\n        totalcount: totalCount,\n        reactedEmojis: reactedEmojis,\n        selected: false,\n    };\n};\n"],"names":["config","cfg","loadDiscussionReactions","async","rows","document","querySelectorAll","length","discussionIds","forEach","row","discussionId","parseInt","getAttribute","push","response","Ajax","call","methodname","args","component","itemtype","discussionids","contextid","reactionsMap","items","item","discussionid","data","counts","renderBar","err","exception","some","c","count","querySelector","context","buildTemplateContext","html","js","Templates","renderForPromise","container","createElement","innerHTML","barElement","firstElementChild","topicTh","wrapperDiv","badgesDiv","after","appendChild","runTemplateJS","countsMap","emoji","buttons","totalCount","reactedEmojis","shortcode","unicode","Object","entries","emojis","hascount","selected","canreact","compactview","hasanycount","totalcount"],"mappings":";;;;;;;4NA4BIA,OAAS,iBAOQC,MACjBD,OAASC,IACTC,iCAMEA,wBAA0BC,gBACtBC,KAAOC,SAASC,iBAAiB,4CAClCF,KAAKG,oBAIJC,cAAgB,MACtBJ,KAAKK,SAASC,YACJC,aAAeC,SAASF,IAAIG,aAAa,sBAC3CF,cACAH,cAAcM,KAAKH,iBAItBH,cAAcD,iBAKTQ,eAAiBC,cAAKC,KAAK,CAAC,CAC9BC,WAAY,2CACZC,KAAM,CACFC,UAAWpB,OAAOoB,UAClBC,SAAUrB,OAAOqB,SACjBC,cAAed,cACfe,UAAWvB,OAAOuB,cAEtB,GAEEC,aAAe,GACrBT,SAASU,MAAMhB,SAASiB,OACpBF,aAAaE,KAAKC,cAAgBD,YAGjC,MAAMf,gBAAgBH,cAAe,OAChCoB,KAAOJ,aAAab,eAAiB,CAACgB,aAAchB,aAAckB,OAAQ,UAC1EC,UAAUnB,aAAciB,OAEpC,MAAOG,2BACQC,UAAUD,OAUzBD,UAAY3B,MAAMQ,aAAciB,YAEdA,KAAKC,OAAOI,MAAMC,GAAMA,EAAEC,MAAQ,iBAKhDzB,IAAML,SAAS+B,gFAC0CzB,wBAE1DD,KAAOA,IAAI0B,cAAc,8CAIxBC,QAAUC,qBAAqBV,gBAG3BW,KAACA,KAADC,GAAOA,UAAYC,mBAAUC,iBAAiB,4CAA6CL,SAC3FM,UAAYtC,SAASuC,cAAc,OACzCD,UAAUE,UAAYN,WAChBO,WAAaH,UAAUI,kBAGvBC,QAAUtC,IAAI0B,cAAc,gBAC7BY,qBAGCC,WAAaD,QAAQZ,cAAc,YACpCa,wBAICC,UADYD,WAAW3C,iBAAiB,gBAClB,GACxB4C,UACAA,UAAUC,MAAML,YAEhBG,WAAWG,YAAYN,+BAEjBO,cAAcb,IAC1B,MAAOT,2BACQC,UAAUD,OAYzBO,qBAAwBV,aACpB0B,UAAY,GAClB1B,KAAKC,OAAOpB,SAASyB,IACjBoB,UAAUpB,EAAEqB,OAASrB,EAAEC,eAGrBqB,QAAU,OACZC,WAAa,QACXC,cAAgB,OAEjB,MAAOC,UAAWC,WAAYC,OAAOC,QAAQ9D,OAAO+D,QAAS,OACxD5B,MAAQmB,UAAUK,YAAc,EACtCH,QAAQ1C,KAAK,CACT6C,UAAWA,UACXC,QAASA,QACTzB,MAAOA,MACP6B,SAAU7B,MAAQ,EAClB8B,UAAU,EACVC,UAAU,IAEV/B,MAAQ,IACRsB,YAActB,MACduB,cAAc5C,KAAK,CAAC8C,QAASA,iBAI9B,CACHJ,QAASA,QACTU,UAAU,EACVC,YAAanE,OAAOmE,YACpBC,YAAaX,WAAa,EAC1BY,WAAYZ,WACZC,cAAeA,cACfO,UAAU"}