define("local_reactions/reactions",["exports","core/ajax","core/templates","core/notification","local_reactions/cache","local_reactions/utils"],(function(_exports,_ajax,_templates,_notification,Cache,_utils){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * AMD module for emoji reactions on forum posts (GitHub-style picker).
   *
   * Renders cached reactions instantly from IndexedDB, then refreshes from the
   * web service and animates any differences.
   *
   * @module     local_reactions/reactions
   * @copyright  2026 Andrew Rowatt <A.J.Rowatt@massey.ac.nz>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification),Cache=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(Cache);let config={};let currentDataMap={},toggleInProgress=!1,pollingInitialised=!1;_exports.init=cfg=>{config=cfg,loadReactions(),document.addEventListener("click",(e=>{e.target.closest(".local-reactions-picker-wrapper")||closeAllPickers()}));const container=document.querySelector('[data-content="forum-discussion"]');if(container){new MutationObserver((mutations=>{for(const mutation of mutations)for(const node of mutation.addedNodes)if(node.nodeType===Node.ELEMENT_NODE&&node.querySelector("article[data-post-id]"))return void loadReactions()})).observe(container,{childList:!0,subtree:!0})}};const closeAllPickers=()=>{document.querySelectorAll('[data-region="reactions-picker"]:not([hidden])').forEach((picker=>{var _picker$closest;picker.hidden=!0;const trigger=null===(_picker$closest=picker.closest(".local-reactions-picker-wrapper"))||void 0===_picker$closest?void 0:_picker$closest.querySelector('[data-action="open-picker"]');trigger&&trigger.setAttribute("aria-expanded","false")}))},insertBeforeActions=(article,element)=>{const actionsContainer=article.querySelector('[data-region="post-actions-container"]');if(actionsContainer)actionsContainer.parentElement.insertBefore(element,actionsContainer);else{const postCore=article.querySelector('[data-region-content="forum-post-core"]');postCore&&postCore.appendChild(element)}},createSkeleton=()=>{const skeleton=document.createElement("div");if(skeleton.className="local-reactions-bar local-reactions-skeleton d-flex flex-wrap align-items-center mt-2 mb-1",skeleton.setAttribute("data-region","reactions-skeleton"),config.compactview){const pill=document.createElement("span");pill.className="local-reactions-skeleton-pill local-reactions-skeleton-pill-compact",skeleton.appendChild(pill)}else for(let i=0;i<3;i++){const pill=document.createElement("span");pill.className="local-reactions-skeleton-pill",skeleton.appendChild(pill)}return skeleton},loadReactions=async()=>{const articles=document.querySelectorAll("article[data-post-id]");if(!articles.length)return;const postIds=[];if(articles.forEach((article=>{const postId=parseInt(article.getAttribute("data-post-id"));postId&&!article.querySelector('[data-region="reactions-bar"]')&&postIds.push(postId)})),!postIds.length)return;const cachedPostIds=new Set,cachedDataMap={},cacheAvailable=await Cache.isAvailable();if(cacheAvailable){const cacheKeys=postIds.map((id=>Cache.itemKey(config.component,config.itemtype,id))),cached=await Cache.getMultiple(cacheKeys),renderPromises=[];for(const postId of postIds){const key=Cache.itemKey(config.component,config.itemtype,postId),cachedData=cached.get(key);cachedData&&(cachedDataMap[postId]=cachedData,cachedPostIds.add(postId),renderPromises.push(renderBar(postId,cachedData,!0)))}await Promise.all(renderPromises)}const uncachedPostIds=postIds.filter((id=>!cachedPostIds.has(id)));uncachedPostIds.length>0&&(postIds=>{for(const postId of postIds){const article=document.querySelector('article[data-post-id="'.concat(postId,'"]'));article&&!article.querySelector('[data-region="reactions-skeleton"]')&&insertBeforeActions(article,createSkeleton())}})(uncachedPostIds);try{const response=await _ajax.default.call([{methodname:"local_reactions_get_reactions",args:{component:config.component,itemtype:config.itemtype,itemids:postIds,contextid:config.contextid}}])[0],reactionsMap={};response.items.forEach((item=>{reactionsMap[item.itemid]=item}));const cacheEntries=[];for(const postId of postIds){const freshData=reactionsMap[postId]||{itemid:postId,userreactions:[],counts:[]};if(cachedPostIds.has(postId)){const diffs=(0,_utils.computeDiffs)(cachedDataMap[postId],freshData);await rerenderBarWithAnimation(postId,freshData,diffs)}else await renderBar(postId,freshData,!1);currentDataMap[postId]=freshData,cacheAvailable&&cacheEntries.push({key:Cache.itemKey(config.component,config.itemtype,postId),data:{counts:freshData.counts||[]}})}cacheEntries.length>0&&await Cache.setMultiple(cacheEntries)}catch(err){_notification.default.exception(err)}pollingInitialised||(pollingInitialised=!0,(0,_utils.createPoller)(config.pollinterval,pollReactions))},renderBar=async(postId,data,fromCache)=>{const article=document.querySelector('article[data-post-id="'.concat(postId,'"]'));if(!article||article.querySelector('[data-region="reactions-bar"]'))return;const context=(0,_utils.buildTemplateContext)(data,config.emojis,{canreact:config.canreact,compactview:config.compactview,userreactions:fromCache?[]:data.userreactions||[]});try{const{element:barElement,js:js}=await(0,_utils.renderToElement)("local_reactions/reactions_bar",context);barElement.setAttribute("data-source",fromCache?"cache":"live");const skeleton=article.querySelector('[data-region="reactions-skeleton"]');skeleton?skeleton.replaceWith(barElement):insertBeforeActions(article,barElement),_templates.default.runTemplateJS(js),fromCache?barElement.querySelectorAll("button").forEach((b=>b.setAttribute("disabled","disabled"))):bindHandlers(barElement,postId)}catch(err){_notification.default.exception(err)}},rerenderBarWithAnimation=async(postId,freshData,diffs)=>{const article=document.querySelector('article[data-post-id="'.concat(postId,'"]'));if(!article)return;const existingBar=article.querySelector('[data-region="reactions-bar"]');if(!existingBar)return;const context=(0,_utils.buildTemplateContext)(freshData,config.emojis,{canreact:config.canreact,compactview:config.compactview,userreactions:freshData.userreactions||[]});try{const{element:newBar,js:js}=await(0,_utils.renderToElement)("local_reactions/reactions_bar",context);if(newBar.setAttribute("data-source","live"),diffs.hasChanges)if(config.compactview){const compactPill=newBar.querySelector(".local-reactions-pill-compact");compactPill&&compactPill.classList.add("local-reactions-count-changed")}else newBar.querySelectorAll("[data-emoji]").forEach((pill=>{const emoji=pill.getAttribute("data-emoji");diffs.changedEmojis.has(emoji)&&pill.classList.add("local-reactions-count-changed"),diffs.newEmojis.has(emoji)&&pill.classList.add("local-reactions-pill-new")}));existingBar.replaceWith(newBar),_templates.default.runTemplateJS(js),bindHandlers(newBar,postId),diffs.hasChanges&&setTimeout((()=>{newBar.querySelectorAll(".local-reactions-count-changed, .local-reactions-pill-new").forEach((el=>{el.classList.remove("local-reactions-count-changed","local-reactions-pill-new")}))}),2100)}catch(err){_notification.default.exception(err)}},bindHandlers=(barElement,postId)=>{barElement.querySelectorAll('[data-action="open-picker"]').forEach((trigger=>{trigger.addEventListener("click",(e=>{e.stopPropagation();const picker=barElement.querySelector('[data-region="reactions-picker"]');if(!picker)return;const isOpen=!picker.hidden;if(closeAllPickers(),!isOpen){const rect=trigger.getBoundingClientRect();picker.style.left=rect.left+"px",picker.style.top=rect.top-picker.offsetHeight-6+"px",picker.hidden=!1,picker.style.top=rect.top-picker.offsetHeight-6+"px",trigger.setAttribute("aria-expanded","true")}}))})),config.canreact&&barElement.querySelectorAll('[data-action="toggle-reaction"]').forEach((btn=>{btn.addEventListener("click",(async e=>{e.preventDefault(),e.stopPropagation(),closeAllPickers();const emoji=btn.getAttribute("data-emoji");await toggleReaction(postId,emoji,barElement)}))}))},toggleReaction=async(postId,emoji,barElement)=>{barElement.querySelectorAll("button").forEach((b=>b.setAttribute("disabled","disabled"))),toggleInProgress=!0;try{const response=await _ajax.default.call([{methodname:"local_reactions_toggle_reaction",args:{component:config.component,itemtype:config.itemtype,itemid:postId,emoji:emoji}}])[0],freshData={userreactions:response.userreactions,counts:response.counts},context=(0,_utils.buildTemplateContext)(freshData,config.emojis,{canreact:config.canreact,compactview:config.compactview,userreactions:freshData.userreactions||[]}),{element:newBar,js:js}=await(0,_utils.renderToElement)("local_reactions/reactions_bar",context);newBar.setAttribute("data-source","live"),barElement.replaceWith(newBar),_templates.default.runTemplateJS(js),bindHandlers(newBar,postId),currentDataMap[postId]=freshData;await Cache.isAvailable()&&await Cache.set(Cache.itemKey(config.component,config.itemtype,postId),{counts:response.counts})}catch(err){_notification.default.exception(err),barElement.querySelectorAll("button").forEach((b=>b.removeAttribute("disabled")))}finally{toggleInProgress=!1}},pollReactions=async()=>{if(toggleInProgress)return;const postIds=(0,_utils.collectIds)("article[data-post-id]","data-post-id");if(postIds.length)try{const response=await _ajax.default.call([{methodname:"local_reactions_get_reactions",args:{component:config.component,itemtype:config.itemtype,itemids:postIds,contextid:config.contextid}}])[0],reactionsMap={};response.items.forEach((item=>{reactionsMap[item.itemid]=item}));const cacheAvailable=await Cache.isAvailable(),cacheEntries=[];for(const postId of postIds){const freshData=reactionsMap[postId]||{itemid:postId,userreactions:[],counts:[]},previousData=currentDataMap[postId];if(previousData){const diffs=(0,_utils.computeDiffs)(previousData,freshData);diffs.hasChanges&&await rerenderBarWithAnimation(postId,freshData,diffs)}currentDataMap[postId]=freshData,cacheAvailable&&cacheEntries.push({key:Cache.itemKey(config.component,config.itemtype,postId),data:{counts:freshData.counts||[]}})}cacheEntries.length>0&&await Cache.setMultiple(cacheEntries)}catch{}}}));

//# sourceMappingURL=reactions.min.js.map