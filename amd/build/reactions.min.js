define("local_reactions/reactions",["exports","core/ajax","core/templates","core/notification"],(function(_exports,_ajax,_templates,_notification){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * AMD module for emoji reactions on forum posts (GitHub-style picker).
   *
   * @module     local_reactions/reactions
   * @copyright  2026 Andrew Rowatt <A.J.Rowatt@massey.ac.nz>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification);let config={};_exports.init=cfg=>{config=cfg,loadReactions(),document.addEventListener("click",(e=>{e.target.closest(".local-reactions-picker-wrapper")||closeAllPickers()}));const container=document.querySelector('[data-content="forum-discussion"]');if(container){new MutationObserver((mutations=>{for(const mutation of mutations)for(const node of mutation.addedNodes)if(node.nodeType===Node.ELEMENT_NODE&&node.querySelector("article[data-post-id]"))return void loadReactions()})).observe(container,{childList:!0,subtree:!0})}};const closeAllPickers=()=>{document.querySelectorAll('[data-region="reactions-picker"]:not([hidden])').forEach((picker=>{var _picker$closest;picker.hidden=!0;const trigger=null===(_picker$closest=picker.closest(".local-reactions-picker-wrapper"))||void 0===_picker$closest?void 0:_picker$closest.querySelector('[data-action="open-picker"]');trigger&&trigger.setAttribute("aria-expanded","false")}))},loadReactions=async()=>{const articles=document.querySelectorAll("article[data-post-id]");if(!articles.length)return;const postIds=[];if(articles.forEach((article=>{const postId=parseInt(article.getAttribute("data-post-id"));postId&&!article.querySelector('[data-region="reactions-bar"]')&&postIds.push(postId)})),postIds.length)try{const response=await _ajax.default.call([{methodname:"local_reactions_get_reactions",args:{component:config.component,itemtype:config.itemtype,itemids:postIds,contextid:config.contextid}}])[0],reactionsMap={};response.items.forEach((item=>{reactionsMap[item.itemid]=item}));for(const postId of postIds){const data=reactionsMap[postId]||{itemid:postId,userreaction:"",counts:[]};await renderBar(postId,data)}}catch(err){_notification.default.exception(err)}},renderBar=async(postId,data)=>{const article=document.querySelector('article[data-post-id="'.concat(postId,'"]'));if(!article||article.querySelector('[data-region="reactions-bar"]'))return;const context=buildTemplateContext(data);try{const{html:html,js:js}=await _templates.default.renderForPromise("local_reactions/reactions_bar",context),container=document.createElement("div");container.innerHTML=html;const barElement=container.firstElementChild,actionsContainer=article.querySelector('[data-region="post-actions-container"]');if(actionsContainer)actionsContainer.parentElement.insertBefore(barElement,actionsContainer);else{const postCore=article.querySelector('[data-region-content="forum-post-core"]');if(!postCore)return;postCore.appendChild(barElement)}_templates.default.runTemplateJS(js),bindHandlers(barElement,postId)}catch(err){_notification.default.exception(err)}},buildTemplateContext=data=>{const countsMap={};data.counts.forEach((c=>{countsMap[c.emoji]=c.count}));const buttons=[];for(const[shortcode,unicode]of Object.entries(config.emojis)){const count=countsMap[shortcode]||0,isSelected=data.userreaction===shortcode;buttons.push({shortcode:shortcode,unicode:unicode,count:count,hascount:count>0,selected:isSelected,canreact:config.canreact})}return{buttons:buttons,canreact:config.canreact}},bindHandlers=(barElement,postId)=>{const trigger=barElement.querySelector('[data-action="open-picker"]');trigger&&trigger.addEventListener("click",(e=>{e.stopPropagation();const picker=barElement.querySelector('[data-region="reactions-picker"]');if(!picker)return;const isOpen=!picker.hidden;closeAllPickers(),isOpen||(picker.hidden=!1,trigger.setAttribute("aria-expanded","true"))})),config.canreact&&barElement.querySelectorAll('[data-action="toggle-reaction"]').forEach((btn=>{btn.addEventListener("click",(async e=>{e.preventDefault(),e.stopPropagation(),closeAllPickers();const emoji=btn.getAttribute("data-emoji");await toggleReaction(postId,emoji,barElement)}))}))},toggleReaction=async(postId,emoji,barElement)=>{barElement.querySelectorAll("button").forEach((b=>b.setAttribute("disabled","disabled")));try{const response=await _ajax.default.call([{methodname:"local_reactions_toggle_reaction",args:{component:config.component,itemtype:config.itemtype,itemid:postId,emoji:emoji}}])[0],context=buildTemplateContext({userreaction:response.userreaction,counts:response.counts}),{html:html,js:js}=await _templates.default.renderForPromise("local_reactions/reactions_bar",context),container=document.createElement("div");container.innerHTML=html;const newBar=container.firstElementChild;barElement.replaceWith(newBar),_templates.default.runTemplateJS(js),bindHandlers(newBar,postId)}catch(err){_notification.default.exception(err),barElement.querySelectorAll("button").forEach((b=>b.removeAttribute("disabled")))}}}));

//# sourceMappingURL=reactions.min.js.map