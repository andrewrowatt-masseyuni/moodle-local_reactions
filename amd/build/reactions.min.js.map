{"version":3,"file":"reactions.min.js","sources":["../src/reactions.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD module for emoji reactions on forum posts (GitHub-style picker).\n *\n * @module     local_reactions/reactions\n * @copyright  2026 Andrew Rowatt <A.J.Rowatt@massey.ac.nz>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\n\n/** @var {Object} Module-level config set during init. */\nlet config = {};\n\n/**\n * Initialise the reactions module.\n *\n * @param {Object} cfg Configuration from PHP.\n */\nexport const init = (cfg) => {\n    config = cfg;\n    loadReactions();\n\n    // Close any open picker when clicking outside.\n    document.addEventListener('click', (e) => {\n        if (!e.target.closest('.local-reactions-picker-wrapper')) {\n            closeAllPickers();\n        }\n    });\n\n    // Re-load when new replies are dynamically added.\n    const container = document.querySelector('[data-content=\"forum-discussion\"]');\n    if (container) {\n        const observer = new MutationObserver((mutations) => {\n            for (const mutation of mutations) {\n                for (const node of mutation.addedNodes) {\n                    if (node.nodeType === Node.ELEMENT_NODE && node.querySelector('article[data-post-id]')) {\n                        loadReactions();\n                        return;\n                    }\n                }\n            }\n        });\n        observer.observe(container, {childList: true, subtree: true});\n    }\n};\n\n/**\n * Close all open emoji pickers.\n */\nconst closeAllPickers = () => {\n    document.querySelectorAll('[data-region=\"reactions-picker\"]:not([hidden])').forEach((picker) => {\n        picker.hidden = true;\n        const trigger = picker.closest('.local-reactions-picker-wrapper')\n            ?.querySelector('[data-action=\"open-picker\"]');\n        if (trigger) {\n            trigger.setAttribute('aria-expanded', 'false');\n        }\n    });\n};\n\n/**\n * Create a skeleton placeholder element for a reactions bar.\n *\n * @returns {HTMLElement} The skeleton element.\n */\nconst createSkeleton = () => {\n    const skeleton = document.createElement('div');\n    skeleton.className = 'local-reactions-bar local-reactions-skeleton d-flex flex-wrap align-items-center mt-2 mb-1';\n    skeleton.setAttribute('data-region', 'reactions-skeleton');\n    if (config.compactview) {\n        const pill = document.createElement('span');\n        pill.className = 'local-reactions-skeleton-pill local-reactions-skeleton-pill-compact';\n        skeleton.appendChild(pill);\n    } else {\n        for (let i = 0; i < 3; i++) {\n            const pill = document.createElement('span');\n            pill.className = 'local-reactions-skeleton-pill';\n            skeleton.appendChild(pill);\n        }\n    }\n    return skeleton;\n};\n\n/**\n * Insert skeleton placeholders into articles that don't yet have a reactions bar.\n *\n * @param {number[]} postIds The post IDs to insert skeletons for.\n */\nconst insertSkeletons = (postIds) => {\n    for (const postId of postIds) {\n        const article = document.querySelector(`article[data-post-id=\"${postId}\"]`);\n        if (!article || article.querySelector('[data-region=\"reactions-skeleton\"]')) {\n            continue;\n        }\n        const skeleton = createSkeleton();\n        const actionsContainer = article.querySelector('[data-region=\"post-actions-container\"]');\n        if (actionsContainer) {\n            actionsContainer.parentElement.insertBefore(skeleton, actionsContainer);\n        } else {\n            const postCore = article.querySelector('[data-region-content=\"forum-post-core\"]');\n            if (postCore) {\n                postCore.appendChild(skeleton);\n            }\n        }\n    }\n};\n\n/**\n * Find all forum post articles on the page and load their reactions.\n */\nconst loadReactions = async() => {\n    const articles = document.querySelectorAll('article[data-post-id]');\n    if (!articles.length) {\n        return;\n    }\n\n    const postIds = [];\n    articles.forEach((article) => {\n        const postId = parseInt(article.getAttribute('data-post-id'));\n        if (postId && !article.querySelector('[data-region=\"reactions-bar\"]')) {\n            postIds.push(postId);\n        }\n    });\n\n    if (!postIds.length) {\n        return;\n    }\n\n    insertSkeletons(postIds);\n\n    try {\n        const response = await Ajax.call([{\n            methodname: 'local_reactions_get_reactions',\n            args: {\n                component: config.component,\n                itemtype: config.itemtype,\n                itemids: postIds,\n                contextid: config.contextid,\n            },\n        }])[0];\n\n        const reactionsMap = {};\n        response.items.forEach((item) => {\n            reactionsMap[item.itemid] = item;\n        });\n\n        for (const postId of postIds) {\n            const data = reactionsMap[postId] || {itemid: postId, userreactions: [], counts: []};\n            await renderBar(postId, data);\n        }\n    } catch (err) {\n        Notification.exception(err);\n    }\n};\n\n/**\n * Build the template context and render the reactions bar into a post.\n *\n * @param {number} postId The forum post ID.\n * @param {Object} data Reaction data from the web service.\n */\nconst renderBar = async(postId, data) => {\n    const article = document.querySelector(`article[data-post-id=\"${postId}\"]`);\n    if (!article || article.querySelector('[data-region=\"reactions-bar\"]')) {\n        return;\n    }\n\n    const context = buildTemplateContext(data);\n\n    try {\n        const {html, js} = await Templates.renderForPromise('local_reactions/reactions_bar', context);\n        const container = document.createElement('div');\n        container.innerHTML = html;\n        const barElement = container.firstElementChild;\n\n        // Replace skeleton if present, otherwise insert at the usual location.\n        const skeleton = article.querySelector('[data-region=\"reactions-skeleton\"]');\n        if (skeleton) {\n            skeleton.replaceWith(barElement);\n        } else {\n            const actionsContainer = article.querySelector('[data-region=\"post-actions-container\"]');\n            if (actionsContainer) {\n                actionsContainer.parentElement.insertBefore(barElement, actionsContainer);\n            } else {\n                const postCore = article.querySelector('[data-region-content=\"forum-post-core\"]');\n                if (!postCore) {\n                    return;\n                }\n                postCore.appendChild(barElement);\n            }\n        }\n        Templates.runTemplateJS(js);\n        bindHandlers(barElement, postId);\n    } catch (err) {\n        Notification.exception(err);\n    }\n};\n\n/**\n * Build Mustache template context from reaction data.\n *\n * @param {Object} data Reaction data.\n * @returns {Object} Template context.\n */\nconst buildTemplateContext = (data) => {\n    const countsMap = {};\n    data.counts.forEach((c) => {\n        countsMap[c.emoji] = c.count;\n    });\n\n    const userReactions = data.userreactions || [];\n    const buttons = [];\n    let totalCount = 0;\n    const reactedEmojis = [];\n    let hasAnySelected = false;\n\n    for (const [shortcode, unicode] of Object.entries(config.emojis)) {\n        const count = countsMap[shortcode] || 0;\n        const isSelected = userReactions.includes(shortcode);\n        buttons.push({\n            shortcode: shortcode,\n            unicode: unicode,\n            count: count,\n            hascount: count > 0,\n            selected: isSelected,\n            canreact: config.canreact,\n        });\n        if (count > 0) {\n            totalCount += count;\n            reactedEmojis.push({unicode: unicode});\n            if (isSelected) {\n                hasAnySelected = true;\n            }\n        }\n    }\n\n    return {\n        buttons: buttons,\n        canreact: config.canreact,\n        compactview: config.compactview,\n        hasanycount: totalCount > 0,\n        totalcount: totalCount,\n        reactedEmojis: reactedEmojis,\n        selected: hasAnySelected,\n    };\n};\n\n/**\n * Bind all event handlers for a reactions bar.\n *\n * @param {HTMLElement} barElement The reactions bar container.\n * @param {number} postId The forum post ID.\n */\nconst bindHandlers = (barElement, postId) => {\n    // Picker trigger buttons (smiley trigger and compact pill both use data-action=\"open-picker\").\n    barElement.querySelectorAll('[data-action=\"open-picker\"]').forEach((trigger) => {\n        trigger.addEventListener('click', (e) => {\n            e.stopPropagation();\n            const picker = barElement.querySelector('[data-region=\"reactions-picker\"]');\n            if (!picker) {\n                return;\n            }\n            const isOpen = !picker.hidden;\n            closeAllPickers();\n            if (!isOpen) {\n                // Position the picker using fixed coordinates to escape overflow:hidden parents.\n                const rect = trigger.getBoundingClientRect();\n                picker.style.left = rect.left + 'px';\n                picker.style.top = (rect.top - picker.offsetHeight - 6) + 'px';\n                picker.hidden = false;\n                // Re-calculate now that it's visible and has a real height.\n                picker.style.top = (rect.top - picker.offsetHeight - 6) + 'px';\n                trigger.setAttribute('aria-expanded', 'true');\n            }\n        });\n    });\n\n    // All toggle-reaction buttons (pills + picker buttons).\n    if (config.canreact) {\n        barElement.querySelectorAll('[data-action=\"toggle-reaction\"]').forEach((btn) => {\n            btn.addEventListener('click', async(e) => {\n                e.preventDefault();\n                e.stopPropagation();\n                closeAllPickers();\n                const emoji = btn.getAttribute('data-emoji');\n                await toggleReaction(postId, emoji, barElement);\n            });\n        });\n    }\n};\n\n/**\n * Toggle a reaction via the web service and rebuild the bar.\n *\n * @param {number} postId The forum post ID.\n * @param {string} emoji The emoji shortcode.\n * @param {HTMLElement} barElement The reactions bar to replace.\n */\nconst toggleReaction = async(postId, emoji, barElement) => {\n    // Disable all interactive elements during the request.\n    barElement.querySelectorAll('button').forEach((b) => b.setAttribute('disabled', 'disabled'));\n\n    try {\n        const response = await Ajax.call([{\n            methodname: 'local_reactions_toggle_reaction',\n            args: {\n                component: config.component,\n                itemtype: config.itemtype,\n                itemid: postId,\n                emoji: emoji,\n            },\n        }])[0];\n\n        // Rebuild the bar with fresh data to correctly show/hide pills.\n        const context = buildTemplateContext({\n            userreactions: response.userreactions,\n            counts: response.counts,\n        });\n        const {html, js} = await Templates.renderForPromise('local_reactions/reactions_bar', context);\n        const container = document.createElement('div');\n        container.innerHTML = html;\n        const newBar = container.firstElementChild;\n\n        barElement.replaceWith(newBar);\n        Templates.runTemplateJS(js);\n        bindHandlers(newBar, postId);\n    } catch (err) {\n        Notification.exception(err);\n        // Re-enable buttons on error.\n        barElement.querySelectorAll('button').forEach((b) => b.removeAttribute('disabled'));\n    }\n};\n"],"names":["config","cfg","loadReactions","document","addEventListener","e","target","closest","closeAllPickers","container","querySelector","MutationObserver","mutations","mutation","node","addedNodes","nodeType","Node","ELEMENT_NODE","observe","childList","subtree","querySelectorAll","forEach","picker","hidden","trigger","_picker$closest","setAttribute","createSkeleton","skeleton","createElement","className","compactview","pill","appendChild","i","async","articles","length","postIds","article","postId","parseInt","getAttribute","push","actionsContainer","parentElement","insertBefore","postCore","insertSkeletons","response","Ajax","call","methodname","args","component","itemtype","itemids","contextid","reactionsMap","items","item","itemid","data","userreactions","counts","renderBar","err","exception","context","buildTemplateContext","html","js","Templates","renderForPromise","innerHTML","barElement","firstElementChild","replaceWith","runTemplateJS","bindHandlers","countsMap","c","emoji","count","userReactions","buttons","totalCount","reactedEmojis","hasAnySelected","shortcode","unicode","Object","entries","emojis","isSelected","includes","hascount","selected","canreact","hasanycount","totalcount","stopPropagation","isOpen","rect","getBoundingClientRect","style","left","top","offsetHeight","btn","preventDefault","toggleReaction","b","newBar","removeAttribute"],"mappings":";;;;;;;4NA4BIA,OAAS,iBAOQC,MACjBD,OAASC,IACTC,gBAGAC,SAASC,iBAAiB,SAAUC,IAC3BA,EAAEC,OAAOC,QAAQ,oCAClBC,2BAKFC,UAAYN,SAASO,cAAc,wCACrCD,UAAW,CACM,IAAIE,kBAAkBC,gBAC9B,MAAMC,YAAYD,cACd,MAAME,QAAQD,SAASE,cACpBD,KAAKE,WAAaC,KAAKC,cAAgBJ,KAAKJ,cAAc,qCAC1DR,mBAMPiB,QAAQV,UAAW,CAACW,WAAW,EAAMC,SAAS,YAOzDb,gBAAkB,KACpBL,SAASmB,iBAAiB,kDAAkDC,SAASC,6BACjFA,OAAOC,QAAS,QACVC,gCAAUF,OAAOjB,QAAQ,qEAAfoB,gBACVjB,cAAc,+BAChBgB,SACAA,QAAQE,aAAa,gBAAiB,aAU5CC,eAAiB,WACbC,SAAW3B,SAAS4B,cAAc,UACxCD,SAASE,UAAY,6FACrBF,SAASF,aAAa,cAAe,sBACjC5B,OAAOiC,YAAa,OACdC,KAAO/B,SAAS4B,cAAc,QACpCG,KAAKF,UAAY,sEACjBF,SAASK,YAAYD,eAEhB,IAAIE,EAAI,EAAGA,EAAI,EAAGA,IAAK,OAClBF,KAAO/B,SAAS4B,cAAc,QACpCG,KAAKF,UAAY,gCACjBF,SAASK,YAAYD,aAGtBJ,UA8BL5B,cAAgBmC,gBACZC,SAAWnC,SAASmB,iBAAiB,6BACtCgB,SAASC,oBAIRC,QAAU,MAChBF,SAASf,SAASkB,gBACRC,OAASC,SAASF,QAAQG,aAAa,iBACzCF,SAAWD,QAAQ/B,cAAc,kCACjC8B,QAAQK,KAAKH,WAIhBF,QAAQD,QApCQC,CAAAA,cAChB,MAAME,UAAUF,QAAS,OACpBC,QAAUtC,SAASO,8CAAuCgC,kBAC3DD,SAAWA,QAAQ/B,cAAc,qDAGhCoB,SAAWD,iBACXiB,iBAAmBL,QAAQ/B,cAAc,6CAC3CoC,iBACAA,iBAAiBC,cAAcC,aAAalB,SAAUgB,sBACnD,OACGG,SAAWR,QAAQ/B,cAAc,2CACnCuC,UACAA,SAASd,YAAYL,aA2BjCoB,CAAgBV,mBAGNW,eAAiBC,cAAKC,KAAK,CAAC,CAC9BC,WAAY,gCACZC,KAAM,CACFC,UAAWxD,OAAOwD,UAClBC,SAAUzD,OAAOyD,SACjBC,QAASlB,QACTmB,UAAW3D,OAAO2D,cAEtB,GAEEC,aAAe,GACrBT,SAASU,MAAMtC,SAASuC,OACpBF,aAAaE,KAAKC,QAAUD,YAG3B,MAAMpB,UAAUF,QAAS,OACpBwB,KAAOJ,aAAalB,SAAW,CAACqB,OAAQrB,OAAQuB,cAAe,GAAIC,OAAQ,UAC3EC,UAAUzB,OAAQsB,OAE9B,MAAOI,2BACQC,UAAUD,QAUzBD,UAAY9B,MAAMK,OAAQsB,cACtBvB,QAAUtC,SAASO,8CAAuCgC,kBAC3DD,SAAWA,QAAQ/B,cAAc,8CAIhC4D,QAAUC,qBAAqBP,gBAG3BQ,KAACA,KAADC,GAAOA,UAAYC,mBAAUC,iBAAiB,gCAAiCL,SAC/E7D,UAAYN,SAAS4B,cAAc,OACzCtB,UAAUmE,UAAYJ,WAChBK,WAAapE,UAAUqE,kBAGvBhD,SAAWW,QAAQ/B,cAAc,yCACnCoB,SACAA,SAASiD,YAAYF,gBAClB,OACG/B,iBAAmBL,QAAQ/B,cAAc,6CAC3CoC,iBACAA,iBAAiBC,cAAcC,aAAa6B,WAAY/B,sBACrD,OACGG,SAAWR,QAAQ/B,cAAc,+CAClCuC,gBAGLA,SAASd,YAAY0C,gCAGnBG,cAAcP,IACxBQ,aAAaJ,WAAYnC,QAC3B,MAAO0B,2BACQC,UAAUD,OAUzBG,qBAAwBP,aACpBkB,UAAY,GAClBlB,KAAKE,OAAO3C,SAAS4D,IACjBD,UAAUC,EAAEC,OAASD,EAAEE,eAGrBC,cAAgBtB,KAAKC,eAAiB,GACtCsB,QAAU,OACZC,WAAa,QACXC,cAAgB,OAClBC,gBAAiB,MAEhB,MAAOC,UAAWC,WAAYC,OAAOC,QAAQ9F,OAAO+F,QAAS,OACxDV,MAAQH,UAAUS,YAAc,EAChCK,WAAaV,cAAcW,SAASN,WAC1CJ,QAAQ1C,KAAK,CACT8C,UAAWA,UACXC,QAASA,QACTP,MAAOA,MACPa,SAAUb,MAAQ,EAClBc,SAAUH,WACVI,SAAUpG,OAAOoG,WAEjBf,MAAQ,IACRG,YAAcH,MACdI,cAAc5C,KAAK,CAAC+C,QAASA,UACzBI,aACAN,gBAAiB,UAKtB,CACHH,QAASA,QACTa,SAAUpG,OAAOoG,SACjBnE,YAAajC,OAAOiC,YACpBoE,YAAab,WAAa,EAC1Bc,WAAYd,WACZC,cAAeA,cACfU,SAAUT,iBAUZT,aAAe,CAACJ,WAAYnC,UAE9BmC,WAAWvD,iBAAiB,+BAA+BC,SAASG,UAChEA,QAAQtB,iBAAiB,SAAUC,IAC/BA,EAAEkG,wBACI/E,OAASqD,WAAWnE,cAAc,wCACnCc,oBAGCgF,QAAUhF,OAAOC,UACvBjB,mBACKgG,OAAQ,OAEHC,KAAO/E,QAAQgF,wBACrBlF,OAAOmF,MAAMC,KAAOH,KAAKG,KAAO,KAChCpF,OAAOmF,MAAME,IAAOJ,KAAKI,IAAMrF,OAAOsF,aAAe,EAAK,KAC1DtF,OAAOC,QAAS,EAEhBD,OAAOmF,MAAME,IAAOJ,KAAKI,IAAMrF,OAAOsF,aAAe,EAAK,KAC1DpF,QAAQE,aAAa,gBAAiB,eAM9C5B,OAAOoG,UACPvB,WAAWvD,iBAAiB,mCAAmCC,SAASwF,MACpEA,IAAI3G,iBAAiB,SAASiC,MAAAA,IAC1BhC,EAAE2G,iBACF3G,EAAEkG,kBACF/F,wBACM4E,MAAQ2B,IAAInE,aAAa,oBACzBqE,eAAevE,OAAQ0C,MAAOP,mBAa9CoC,eAAiB5E,MAAMK,OAAQ0C,MAAOP,cAExCA,WAAWvD,iBAAiB,UAAUC,SAAS2F,GAAMA,EAAEtF,aAAa,WAAY,wBAGtEuB,eAAiBC,cAAKC,KAAK,CAAC,CAC9BC,WAAY,kCACZC,KAAM,CACFC,UAAWxD,OAAOwD,UAClBC,SAAUzD,OAAOyD,SACjBM,OAAQrB,OACR0C,MAAOA,UAEX,GAGEd,QAAUC,qBAAqB,CACjCN,cAAed,SAASc,cACxBC,OAAQf,SAASe,UAEfM,KAACA,KAADC,GAAOA,UAAYC,mBAAUC,iBAAiB,gCAAiCL,SAC/E7D,UAAYN,SAAS4B,cAAc,OACzCtB,UAAUmE,UAAYJ,WAChB2C,OAAS1G,UAAUqE,kBAEzBD,WAAWE,YAAYoC,2BACbnC,cAAcP,IACxBQ,aAAakC,OAAQzE,QACvB,MAAO0B,2BACQC,UAAUD,KAEvBS,WAAWvD,iBAAiB,UAAUC,SAAS2F,GAAMA,EAAEE,gBAAgB"}