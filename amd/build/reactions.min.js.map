{"version":3,"file":"reactions.min.js","sources":["../src/reactions.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD module for emoji reactions on forum posts (GitHub-style picker).\n *\n * @module     local_reactions/reactions\n * @copyright  2026 Andrew Rowatt <A.J.Rowatt@massey.ac.nz>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\n\n/** @var {Object} Module-level config set during init. */\nlet config = {};\n\n/**\n * Initialise the reactions module.\n *\n * @param {Object} cfg Configuration from PHP.\n */\nexport const init = (cfg) => {\n    config = cfg;\n    loadReactions();\n\n    // Close any open picker when clicking outside.\n    document.addEventListener('click', (e) => {\n        if (!e.target.closest('.local-reactions-picker-wrapper')) {\n            closeAllPickers();\n        }\n    });\n\n    // Re-load when new replies are dynamically added.\n    const container = document.querySelector('[data-content=\"forum-discussion\"]');\n    if (container) {\n        const observer = new MutationObserver((mutations) => {\n            for (const mutation of mutations) {\n                for (const node of mutation.addedNodes) {\n                    if (node.nodeType === Node.ELEMENT_NODE && node.querySelector('article[data-post-id]')) {\n                        loadReactions();\n                        return;\n                    }\n                }\n            }\n        });\n        observer.observe(container, {childList: true, subtree: true});\n    }\n};\n\n/**\n * Close all open emoji pickers.\n */\nconst closeAllPickers = () => {\n    document.querySelectorAll('[data-region=\"reactions-picker\"]:not([hidden])').forEach((picker) => {\n        picker.hidden = true;\n        const trigger = picker.closest('.local-reactions-picker-wrapper')\n            ?.querySelector('[data-action=\"open-picker\"]');\n        if (trigger) {\n            trigger.setAttribute('aria-expanded', 'false');\n        }\n    });\n};\n\n/**\n * Find all forum post articles on the page and load their reactions.\n */\nconst loadReactions = async() => {\n    const articles = document.querySelectorAll('article[data-post-id]');\n    if (!articles.length) {\n        return;\n    }\n\n    const postIds = [];\n    articles.forEach((article) => {\n        const postId = parseInt(article.getAttribute('data-post-id'));\n        if (postId && !article.querySelector('[data-region=\"reactions-bar\"]')) {\n            postIds.push(postId);\n        }\n    });\n\n    if (!postIds.length) {\n        return;\n    }\n\n    try {\n        const response = await Ajax.call([{\n            methodname: 'local_reactions_get_reactions',\n            args: {\n                component: config.component,\n                itemtype: config.itemtype,\n                itemids: postIds,\n                contextid: config.contextid,\n            },\n        }])[0];\n\n        const reactionsMap = {};\n        response.items.forEach((item) => {\n            reactionsMap[item.itemid] = item;\n        });\n\n        for (const postId of postIds) {\n            const data = reactionsMap[postId] || {itemid: postId, userreactions: [], counts: []};\n            await renderBar(postId, data);\n        }\n    } catch (err) {\n        Notification.exception(err);\n    }\n};\n\n/**\n * Build the template context and render the reactions bar into a post.\n *\n * @param {number} postId The forum post ID.\n * @param {Object} data Reaction data from the web service.\n */\nconst renderBar = async(postId, data) => {\n    const article = document.querySelector(`article[data-post-id=\"${postId}\"]`);\n    if (!article || article.querySelector('[data-region=\"reactions-bar\"]')) {\n        return;\n    }\n\n    const context = buildTemplateContext(data);\n\n    try {\n        const {html, js} = await Templates.renderForPromise('local_reactions/reactions_bar', context);\n        const container = document.createElement('div');\n        container.innerHTML = html;\n        const barElement = container.firstElementChild;\n\n        // Try to insert alongside the post actions (reply posts).\n        const actionsContainer = article.querySelector('[data-region=\"post-actions-container\"]');\n        if (actionsContainer) {\n            actionsContainer.parentElement.insertBefore(barElement, actionsContainer);\n        } else {\n            // Fallback for first post: append to the post core column.\n            const postCore = article.querySelector('[data-region-content=\"forum-post-core\"]');\n            if (!postCore) {\n                return;\n            }\n            postCore.appendChild(barElement);\n        }\n        Templates.runTemplateJS(js);\n        bindHandlers(barElement, postId);\n    } catch (err) {\n        Notification.exception(err);\n    }\n};\n\n/**\n * Build Mustache template context from reaction data.\n *\n * @param {Object} data Reaction data.\n * @returns {Object} Template context.\n */\nconst buildTemplateContext = (data) => {\n    const countsMap = {};\n    data.counts.forEach((c) => {\n        countsMap[c.emoji] = c.count;\n    });\n\n    const userReactions = data.userreactions || [];\n    const buttons = [];\n    let totalCount = 0;\n    const reactedEmojis = [];\n    let hasAnySelected = false;\n\n    for (const [shortcode, unicode] of Object.entries(config.emojis)) {\n        const count = countsMap[shortcode] || 0;\n        const isSelected = userReactions.includes(shortcode);\n        buttons.push({\n            shortcode: shortcode,\n            unicode: unicode,\n            count: count,\n            hascount: count > 0,\n            selected: isSelected,\n            canreact: config.canreact,\n        });\n        if (count > 0) {\n            totalCount += count;\n            reactedEmojis.push({unicode: unicode});\n            if (isSelected) {\n                hasAnySelected = true;\n            }\n        }\n    }\n\n    return {\n        buttons: buttons,\n        canreact: config.canreact,\n        compactview: config.compactview,\n        hasanycount: totalCount > 0,\n        totalcount: totalCount,\n        reactedEmojis: reactedEmojis,\n        selected: hasAnySelected,\n    };\n};\n\n/**\n * Bind all event handlers for a reactions bar.\n *\n * @param {HTMLElement} barElement The reactions bar container.\n * @param {number} postId The forum post ID.\n */\nconst bindHandlers = (barElement, postId) => {\n    // Picker trigger buttons (smiley trigger and compact pill both use data-action=\"open-picker\").\n    barElement.querySelectorAll('[data-action=\"open-picker\"]').forEach((trigger) => {\n        trigger.addEventListener('click', (e) => {\n            e.stopPropagation();\n            const picker = barElement.querySelector('[data-region=\"reactions-picker\"]');\n            if (!picker) {\n                return;\n            }\n            const isOpen = !picker.hidden;\n            closeAllPickers();\n            if (!isOpen) {\n                // Position the picker using fixed coordinates to escape overflow:hidden parents.\n                const rect = trigger.getBoundingClientRect();\n                picker.style.left = rect.left + 'px';\n                picker.style.top = (rect.top - picker.offsetHeight - 6) + 'px';\n                picker.hidden = false;\n                // Re-calculate now that it's visible and has a real height.\n                picker.style.top = (rect.top - picker.offsetHeight - 6) + 'px';\n                trigger.setAttribute('aria-expanded', 'true');\n            }\n        });\n    });\n\n    // All toggle-reaction buttons (pills + picker buttons).\n    if (config.canreact) {\n        barElement.querySelectorAll('[data-action=\"toggle-reaction\"]').forEach((btn) => {\n            btn.addEventListener('click', async(e) => {\n                e.preventDefault();\n                e.stopPropagation();\n                closeAllPickers();\n                const emoji = btn.getAttribute('data-emoji');\n                await toggleReaction(postId, emoji, barElement);\n            });\n        });\n    }\n};\n\n/**\n * Toggle a reaction via the web service and rebuild the bar.\n *\n * @param {number} postId The forum post ID.\n * @param {string} emoji The emoji shortcode.\n * @param {HTMLElement} barElement The reactions bar to replace.\n */\nconst toggleReaction = async(postId, emoji, barElement) => {\n    // Disable all interactive elements during the request.\n    barElement.querySelectorAll('button').forEach((b) => b.setAttribute('disabled', 'disabled'));\n\n    try {\n        const response = await Ajax.call([{\n            methodname: 'local_reactions_toggle_reaction',\n            args: {\n                component: config.component,\n                itemtype: config.itemtype,\n                itemid: postId,\n                emoji: emoji,\n            },\n        }])[0];\n\n        // Rebuild the bar with fresh data to correctly show/hide pills.\n        const context = buildTemplateContext({\n            userreactions: response.userreactions,\n            counts: response.counts,\n        });\n        const {html, js} = await Templates.renderForPromise('local_reactions/reactions_bar', context);\n        const container = document.createElement('div');\n        container.innerHTML = html;\n        const newBar = container.firstElementChild;\n\n        barElement.replaceWith(newBar);\n        Templates.runTemplateJS(js);\n        bindHandlers(newBar, postId);\n    } catch (err) {\n        Notification.exception(err);\n        // Re-enable buttons on error.\n        barElement.querySelectorAll('button').forEach((b) => b.removeAttribute('disabled'));\n    }\n};\n"],"names":["config","cfg","loadReactions","document","addEventListener","e","target","closest","closeAllPickers","container","querySelector","MutationObserver","mutations","mutation","node","addedNodes","nodeType","Node","ELEMENT_NODE","observe","childList","subtree","querySelectorAll","forEach","picker","hidden","trigger","_picker$closest","setAttribute","async","articles","length","postIds","article","postId","parseInt","getAttribute","push","response","Ajax","call","methodname","args","component","itemtype","itemids","contextid","reactionsMap","items","item","itemid","data","userreactions","counts","renderBar","err","exception","context","buildTemplateContext","html","js","Templates","renderForPromise","createElement","innerHTML","barElement","firstElementChild","actionsContainer","parentElement","insertBefore","postCore","appendChild","runTemplateJS","bindHandlers","countsMap","c","emoji","count","userReactions","buttons","totalCount","reactedEmojis","hasAnySelected","shortcode","unicode","Object","entries","emojis","isSelected","includes","hascount","selected","canreact","compactview","hasanycount","totalcount","stopPropagation","isOpen","rect","getBoundingClientRect","style","left","top","offsetHeight","btn","preventDefault","toggleReaction","b","newBar","replaceWith","removeAttribute"],"mappings":"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"}