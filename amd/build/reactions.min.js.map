{"version":3,"file":"reactions.min.js","sources":["../src/reactions.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD module for emoji reactions on forum posts (GitHub-style picker).\n *\n * Renders cached reactions instantly from IndexedDB, then refreshes from the\n * web service and animates any differences.\n *\n * @module     local_reactions/reactions\n * @copyright  2026 Andrew Rowatt <A.J.Rowatt@massey.ac.nz>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\nimport * as Cache from 'local_reactions/cache';\n\n/** @var {Object} Module-level config set during init. */\nlet config = {};\n\n/** @var {number} Duration in ms to keep animation classes before removal. */\nconst ANIMATION_TIMEOUT = 2100;\n\n/**\n * Initialise the reactions module.\n *\n * @param {Object} cfg Configuration from PHP.\n */\nexport const init = (cfg) => {\n    config = cfg;\n    loadReactions();\n\n    // Close any open picker when clicking outside.\n    document.addEventListener('click', (e) => {\n        if (!e.target.closest('.local-reactions-picker-wrapper')) {\n            closeAllPickers();\n        }\n    });\n\n    // Re-load when new replies are dynamically added.\n    const container = document.querySelector('[data-content=\"forum-discussion\"]');\n    if (container) {\n        const observer = new MutationObserver((mutations) => {\n            for (const mutation of mutations) {\n                for (const node of mutation.addedNodes) {\n                    if (node.nodeType === Node.ELEMENT_NODE && node.querySelector('article[data-post-id]')) {\n                        loadReactions();\n                        return;\n                    }\n                }\n            }\n        });\n        observer.observe(container, {childList: true, subtree: true});\n    }\n};\n\n/**\n * Close all open emoji pickers.\n */\nconst closeAllPickers = () => {\n    document.querySelectorAll('[data-region=\"reactions-picker\"]:not([hidden])').forEach((picker) => {\n        picker.hidden = true;\n        const trigger = picker.closest('.local-reactions-picker-wrapper')\n            ?.querySelector('[data-action=\"open-picker\"]');\n        if (trigger) {\n            trigger.setAttribute('aria-expanded', 'false');\n        }\n    });\n};\n\n/**\n * Create a skeleton placeholder element for a reactions bar.\n *\n * @returns {HTMLElement} The skeleton element.\n */\nconst createSkeleton = () => {\n    const skeleton = document.createElement('div');\n    skeleton.className = 'local-reactions-bar local-reactions-skeleton d-flex flex-wrap align-items-center mt-2 mb-1';\n    skeleton.setAttribute('data-region', 'reactions-skeleton');\n    if (config.compactview) {\n        const pill = document.createElement('span');\n        pill.className = 'local-reactions-skeleton-pill local-reactions-skeleton-pill-compact';\n        skeleton.appendChild(pill);\n    } else {\n        for (let i = 0; i < 3; i++) {\n            const pill = document.createElement('span');\n            pill.className = 'local-reactions-skeleton-pill';\n            skeleton.appendChild(pill);\n        }\n    }\n    return skeleton;\n};\n\n/**\n * Insert skeleton placeholders into articles that don't yet have a reactions bar.\n *\n * @param {number[]} postIds The post IDs to insert skeletons for.\n */\nconst insertSkeletons = (postIds) => {\n    for (const postId of postIds) {\n        const article = document.querySelector(`article[data-post-id=\"${postId}\"]`);\n        if (!article || article.querySelector('[data-region=\"reactions-skeleton\"]')) {\n            continue;\n        }\n        const skeleton = createSkeleton();\n        const actionsContainer = article.querySelector('[data-region=\"post-actions-container\"]');\n        if (actionsContainer) {\n            actionsContainer.parentElement.insertBefore(skeleton, actionsContainer);\n        } else {\n            const postCore = article.querySelector('[data-region-content=\"forum-post-core\"]');\n            if (postCore) {\n                postCore.appendChild(skeleton);\n            }\n        }\n    }\n};\n\n/**\n * Find all forum post articles on the page and load their reactions.\n *\n * Uses a cache-first strategy: renders cached counts instantly (read-only),\n * then fetches fresh data from the web service and animates any differences.\n */\nconst loadReactions = async() => {\n    const articles = document.querySelectorAll('article[data-post-id]');\n    if (!articles.length) {\n        return;\n    }\n\n    const postIds = [];\n    articles.forEach((article) => {\n        const postId = parseInt(article.getAttribute('data-post-id'));\n        if (postId && !article.querySelector('[data-region=\"reactions-bar\"]')) {\n            postIds.push(postId);\n        }\n    });\n\n    if (!postIds.length) {\n        return;\n    }\n\n    // Phase 1: Try to render from cache (read-only, no interaction).\n    const cachedPostIds = new Set();\n    const cachedDataMap = {};\n    const cacheAvailable = await Cache.isAvailable();\n\n    if (cacheAvailable) {\n        const cacheKeys = postIds.map((id) => Cache.itemKey(config.component, config.itemtype, id));\n        const cached = await Cache.getMultiple(cacheKeys);\n\n        for (const postId of postIds) {\n            const key = Cache.itemKey(config.component, config.itemtype, postId);\n            const cachedData = cached.get(key);\n            if (cachedData) {\n                cachedDataMap[postId] = cachedData;\n                await renderBar(postId, cachedData, true);\n                cachedPostIds.add(postId);\n            }\n        }\n    }\n\n    // Phase 2: Insert skeletons only for uncached posts.\n    const uncachedPostIds = postIds.filter((id) => !cachedPostIds.has(id));\n    if (uncachedPostIds.length > 0) {\n        insertSkeletons(uncachedPostIds);\n    }\n\n    // Phase 3: Fetch fresh data from web service (for ALL posts).\n    try {\n        const response = await Ajax.call([{\n            methodname: 'local_reactions_get_reactions',\n            args: {\n                component: config.component,\n                itemtype: config.itemtype,\n                itemids: postIds,\n                contextid: config.contextid,\n            },\n        }])[0];\n\n        const reactionsMap = {};\n        response.items.forEach((item) => {\n            reactionsMap[item.itemid] = item;\n        });\n\n        // Phase 4: Update UI and cache.\n        const cacheEntries = [];\n\n        for (const postId of postIds) {\n            const freshData = reactionsMap[postId] || {itemid: postId, userreactions: [], counts: []};\n\n            if (cachedPostIds.has(postId)) {\n                // This post was rendered from cache - compute diffs and re-render with animation.\n                const diffs = computeDiffs(cachedDataMap[postId], freshData);\n                await rerenderBarWithAnimation(postId, freshData, diffs);\n            } else {\n                // This post was not cached - render normally (replaces skeleton).\n                await renderBar(postId, freshData, false);\n            }\n\n            if (cacheAvailable) {\n                cacheEntries.push({\n                    key: Cache.itemKey(config.component, config.itemtype, postId),\n                    data: {counts: freshData.counts || []},\n                });\n            }\n        }\n\n        if (cacheEntries.length > 0) {\n            await Cache.setMultiple(cacheEntries);\n        }\n    } catch (err) {\n        Notification.exception(err);\n    }\n};\n\n/**\n * Build the template context and render the reactions bar into a post.\n *\n * @param {number} postId The forum post ID.\n * @param {Object} data Reaction data.\n * @param {boolean} fromCache Whether this render is from cached data (read-only).\n */\nconst renderBar = async(postId, data, fromCache) => {\n    const article = document.querySelector(`article[data-post-id=\"${postId}\"]`);\n    if (!article || article.querySelector('[data-region=\"reactions-bar\"]')) {\n        return;\n    }\n\n    const context = buildTemplateContext(data, fromCache);\n\n    try {\n        const {html, js} = await Templates.renderForPromise('local_reactions/reactions_bar', context);\n        const container = document.createElement('div');\n        container.innerHTML = html;\n        const barElement = container.firstElementChild;\n        barElement.setAttribute('data-source', fromCache ? 'cache' : 'live');\n\n        // Replace skeleton if present, otherwise insert at the usual location.\n        const skeleton = article.querySelector('[data-region=\"reactions-skeleton\"]');\n        if (skeleton) {\n            skeleton.replaceWith(barElement);\n        } else {\n            const actionsContainer = article.querySelector('[data-region=\"post-actions-container\"]');\n            if (actionsContainer) {\n                actionsContainer.parentElement.insertBefore(barElement, actionsContainer);\n            } else {\n                const postCore = article.querySelector('[data-region-content=\"forum-post-core\"]');\n                if (!postCore) {\n                    return;\n                }\n                postCore.appendChild(barElement);\n            }\n        }\n        Templates.runTemplateJS(js);\n        if (fromCache) {\n            // Disable all buttons so the picker and pills are visible but non-interactive.\n            barElement.querySelectorAll('button').forEach((b) => b.setAttribute('disabled', 'disabled'));\n        } else {\n            bindHandlers(barElement, postId);\n        }\n    } catch (err) {\n        Notification.exception(err);\n    }\n};\n\n/**\n * Compare cached and fresh reaction data to find differences.\n *\n * @param {Object} cachedData Cached reaction data (counts only).\n * @param {Object} freshData Fresh reaction data from web service.\n * @returns {Object} Diffs object.\n */\nconst computeDiffs = (cachedData, freshData) => {\n    const cachedCounts = {};\n    (cachedData?.counts || []).forEach((c) => {\n        cachedCounts[c.emoji] = c.count;\n    });\n\n    const freshCounts = {};\n    (freshData?.counts || []).forEach((c) => {\n        freshCounts[c.emoji] = c.count;\n    });\n\n    const changedEmojis = new Set();\n    const newEmojis = new Set();\n    const removedEmojis = new Set();\n\n    for (const emoji of Object.keys(freshCounts)) {\n        if (!(emoji in cachedCounts)) {\n            if (freshCounts[emoji] > 0) {\n                newEmojis.add(emoji);\n            }\n        } else if (freshCounts[emoji] !== cachedCounts[emoji]) {\n            changedEmojis.add(emoji);\n        }\n    }\n\n    for (const emoji of Object.keys(cachedCounts)) {\n        if (cachedCounts[emoji] > 0 && (!(emoji in freshCounts) || freshCounts[emoji] === 0)) {\n            removedEmojis.add(emoji);\n        }\n    }\n\n    const hasChanges = changedEmojis.size > 0 || newEmojis.size > 0 || removedEmojis.size > 0;\n\n    return {hasChanges, changedEmojis, newEmojis, removedEmojis};\n};\n\n/**\n * Re-render a reactions bar with animation for changed counts.\n *\n * Always re-renders to enable interaction (cache renders are read-only).\n *\n * @param {number} postId The forum post ID.\n * @param {Object} freshData Fresh reaction data from the web service.\n * @param {Object} diffs The diff result from computeDiffs.\n */\nconst rerenderBarWithAnimation = async(postId, freshData, diffs) => {\n    const article = document.querySelector(`article[data-post-id=\"${postId}\"]`);\n    if (!article) {\n        return;\n    }\n\n    const existingBar = article.querySelector('[data-region=\"reactions-bar\"]');\n    if (!existingBar) {\n        return;\n    }\n\n    const context = buildTemplateContext(freshData, false);\n\n    try {\n        const {html, js} = await Templates.renderForPromise('local_reactions/reactions_bar', context);\n        const container = document.createElement('div');\n        container.innerHTML = html;\n        const newBar = container.firstElementChild;\n        newBar.setAttribute('data-source', 'live');\n\n        // Apply animation classes to changed pills before inserting into DOM.\n        if (diffs.hasChanges) {\n            if (!config.compactview) {\n                newBar.querySelectorAll('[data-emoji]').forEach((pill) => {\n                    const emoji = pill.getAttribute('data-emoji');\n                    if (diffs.changedEmojis.has(emoji)) {\n                        pill.classList.add('local-reactions-count-changed');\n                    }\n                    if (diffs.newEmojis.has(emoji)) {\n                        pill.classList.add('local-reactions-pill-new');\n                    }\n                });\n            } else {\n                const compactPill = newBar.querySelector('.local-reactions-pill-compact');\n                if (compactPill) {\n                    compactPill.classList.add('local-reactions-count-changed');\n                }\n            }\n        }\n\n        existingBar.replaceWith(newBar);\n        Templates.runTemplateJS(js);\n        bindHandlers(newBar, postId);\n\n        // Remove animation classes after animation completes.\n        if (diffs.hasChanges) {\n            setTimeout(() => {\n                newBar.querySelectorAll('.local-reactions-count-changed, .local-reactions-pill-new')\n                    .forEach((el) => {\n                        el.classList.remove('local-reactions-count-changed', 'local-reactions-pill-new');\n                    });\n            }, ANIMATION_TIMEOUT);\n        }\n    } catch (err) {\n        Notification.exception(err);\n    }\n};\n\n/**\n * Build Mustache template context from reaction data.\n *\n * @param {Object} data Reaction data.\n * @param {boolean} fromCache Whether rendering from cache (forces selected=false for all pills).\n * @returns {Object} Template context.\n */\nconst buildTemplateContext = (data, fromCache) => {\n    const countsMap = {};\n    data.counts.forEach((c) => {\n        countsMap[c.emoji] = c.count;\n    });\n\n    const userReactions = fromCache ? [] : (data.userreactions || []);\n    const buttons = [];\n    let totalCount = 0;\n    const reactedEmojis = [];\n    let hasAnySelected = false;\n\n    for (const [shortcode, unicode] of Object.entries(config.emojis)) {\n        const count = countsMap[shortcode] || 0;\n        const isSelected = userReactions.includes(shortcode);\n        buttons.push({\n            shortcode: shortcode,\n            unicode: unicode,\n            count: count,\n            hascount: count > 0,\n            selected: isSelected,\n            canreact: config.canreact,\n        });\n        if (count > 0) {\n            totalCount += count;\n            reactedEmojis.push({unicode: unicode});\n            if (isSelected) {\n                hasAnySelected = true;\n            }\n        }\n    }\n\n    return {\n        buttons: buttons,\n        canreact: config.canreact,\n        compactview: config.compactview,\n        hasanycount: totalCount > 0,\n        totalcount: totalCount,\n        reactedEmojis: reactedEmojis,\n        selected: hasAnySelected,\n    };\n};\n\n/**\n * Bind all event handlers for a reactions bar.\n *\n * @param {HTMLElement} barElement The reactions bar container.\n * @param {number} postId The forum post ID.\n */\nconst bindHandlers = (barElement, postId) => {\n    // Picker trigger buttons (smiley trigger and compact pill both use data-action=\"open-picker\").\n    barElement.querySelectorAll('[data-action=\"open-picker\"]').forEach((trigger) => {\n        trigger.addEventListener('click', (e) => {\n            e.stopPropagation();\n            const picker = barElement.querySelector('[data-region=\"reactions-picker\"]');\n            if (!picker) {\n                return;\n            }\n            const isOpen = !picker.hidden;\n            closeAllPickers();\n            if (!isOpen) {\n                // Position the picker using fixed coordinates to escape overflow:hidden parents.\n                const rect = trigger.getBoundingClientRect();\n                picker.style.left = rect.left + 'px';\n                picker.style.top = (rect.top - picker.offsetHeight - 6) + 'px';\n                picker.hidden = false;\n                // Re-calculate now that it's visible and has a real height.\n                picker.style.top = (rect.top - picker.offsetHeight - 6) + 'px';\n                trigger.setAttribute('aria-expanded', 'true');\n            }\n        });\n    });\n\n    // All toggle-reaction buttons (pills + picker buttons).\n    if (config.canreact) {\n        barElement.querySelectorAll('[data-action=\"toggle-reaction\"]').forEach((btn) => {\n            btn.addEventListener('click', async(e) => {\n                e.preventDefault();\n                e.stopPropagation();\n                closeAllPickers();\n                const emoji = btn.getAttribute('data-emoji');\n                await toggleReaction(postId, emoji, barElement);\n            });\n        });\n    }\n};\n\n/**\n * Toggle a reaction via the web service and rebuild the bar.\n *\n * @param {number} postId The forum post ID.\n * @param {string} emoji The emoji shortcode.\n * @param {HTMLElement} barElement The reactions bar to replace.\n */\nconst toggleReaction = async(postId, emoji, barElement) => {\n    // Disable all interactive elements during the request.\n    barElement.querySelectorAll('button').forEach((b) => b.setAttribute('disabled', 'disabled'));\n\n    try {\n        const response = await Ajax.call([{\n            methodname: 'local_reactions_toggle_reaction',\n            args: {\n                component: config.component,\n                itemtype: config.itemtype,\n                itemid: postId,\n                emoji: emoji,\n            },\n        }])[0];\n\n        const freshData = {\n            userreactions: response.userreactions,\n            counts: response.counts,\n        };\n\n        // Rebuild the bar with fresh data to correctly show/hide pills.\n        const context = buildTemplateContext(freshData, false);\n        const {html, js} = await Templates.renderForPromise('local_reactions/reactions_bar', context);\n        const container = document.createElement('div');\n        container.innerHTML = html;\n        const newBar = container.firstElementChild;\n        newBar.setAttribute('data-source', 'live');\n\n        barElement.replaceWith(newBar);\n        Templates.runTemplateJS(js);\n        bindHandlers(newBar, postId);\n\n        // Update the cache with counts only.\n        const cacheAvailable = await Cache.isAvailable();\n        if (cacheAvailable) {\n            await Cache.set(\n                Cache.itemKey(config.component, config.itemtype, postId),\n                {counts: response.counts}\n            );\n        }\n    } catch (err) {\n        Notification.exception(err);\n        // Re-enable buttons on error.\n        barElement.querySelectorAll('button').forEach((b) => b.removeAttribute('disabled'));\n    }\n};\n"],"names":["config","cfg","loadReactions","document","addEventListener","e","target","closest","closeAllPickers","container","querySelector","MutationObserver","mutations","mutation","node","addedNodes","nodeType","Node","ELEMENT_NODE","observe","childList","subtree","querySelectorAll","forEach","picker","hidden","trigger","_picker$closest","setAttribute","createSkeleton","skeleton","createElement","className","compactview","pill","appendChild","i","async","articles","length","postIds","article","postId","parseInt","getAttribute","push","cachedPostIds","Set","cachedDataMap","cacheAvailable","Cache","isAvailable","cacheKeys","map","id","itemKey","component","itemtype","cached","getMultiple","key","cachedData","get","renderBar","add","uncachedPostIds","filter","has","actionsContainer","parentElement","insertBefore","postCore","insertSkeletons","response","Ajax","call","methodname","args","itemids","contextid","reactionsMap","items","item","itemid","cacheEntries","freshData","userreactions","counts","diffs","computeDiffs","rerenderBarWithAnimation","data","setMultiple","err","exception","fromCache","context","buildTemplateContext","html","js","Templates","renderForPromise","innerHTML","barElement","firstElementChild","replaceWith","runTemplateJS","b","bindHandlers","cachedCounts","c","emoji","count","freshCounts","changedEmojis","newEmojis","removedEmojis","Object","keys","hasChanges","size","existingBar","newBar","compactPill","classList","setTimeout","el","remove","countsMap","userReactions","buttons","totalCount","reactedEmojis","hasAnySelected","shortcode","unicode","entries","emojis","isSelected","includes","hascount","selected","canreact","hasanycount","totalcount","stopPropagation","isOpen","rect","getBoundingClientRect","style","left","top","offsetHeight","btn","preventDefault","toggleReaction","set","removeAttribute"],"mappings":"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"}