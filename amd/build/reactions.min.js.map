{"version":3,"file":"reactions.min.js","sources":["../src/reactions.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD module for emoji reactions on forum posts.\n *\n * @module     local_reactions/reactions\n * @copyright  2026 Andrew Rowatt <A.J.Rowatt@massey.ac.nz>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\n\n/** @var {Object} Module-level config set during init. */\nlet config = {};\n\n/**\n * Initialise the reactions module.\n *\n * @param {Object} cfg Configuration from PHP.\n * @param {number} cfg.contextid The module context ID.\n * @param {string} cfg.component Component name e.g. mod_forum.\n * @param {string} cfg.itemtype Item type e.g. post.\n * @param {boolean} cfg.canreact Whether the user can react.\n * @param {Object} cfg.emojis Emoji set as shortcode:unicode map.\n */\nexport const init = (cfg) => {\n    config = cfg;\n    loadReactions();\n\n    // Also re-load when new replies are dynamically added.\n    const observer = new MutationObserver((mutations) => {\n        for (const mutation of mutations) {\n            for (const node of mutation.addedNodes) {\n                if (node.nodeType === Node.ELEMENT_NODE && node.querySelector('article[data-post-id]')) {\n                    loadReactions();\n                    return;\n                }\n            }\n        }\n    });\n\n    const container = document.querySelector('[data-content=\"forum-discussion\"]');\n    if (container) {\n        observer.observe(container, {childList: true, subtree: true});\n    }\n};\n\n/**\n * Find all forum post articles on the page and load their reactions.\n */\nconst loadReactions = async() => {\n    const articles = document.querySelectorAll('article[data-post-id]');\n    if (!articles.length) {\n        return;\n    }\n\n    // Collect post IDs that don't already have a reactions bar.\n    const postIds = [];\n    articles.forEach((article) => {\n        const postId = parseInt(article.getAttribute('data-post-id'));\n        if (postId && !article.querySelector('[data-region=\"reactions-bar\"]')) {\n            postIds.push(postId);\n        }\n    });\n\n    if (!postIds.length) {\n        return;\n    }\n\n    try {\n        const response = await Ajax.call([{\n            methodname: 'local_reactions_get_reactions',\n            args: {\n                component: config.component,\n                itemtype: config.itemtype,\n                itemids: postIds,\n                contextid: config.contextid,\n            },\n        }])[0];\n\n        // Build a lookup map.\n        const reactionsMap = {};\n        response.items.forEach((item) => {\n            reactionsMap[item.itemid] = item;\n        });\n\n        // Render a bar for each post.\n        for (const postId of postIds) {\n            const data = reactionsMap[postId] || {itemid: postId, userreaction: '', counts: []};\n            await renderBar(postId, data);\n        }\n    } catch (err) {\n        Notification.exception(err);\n    }\n};\n\n/**\n * Build the template context and render the reactions bar into a post.\n *\n * @param {number} postId The forum post ID.\n * @param {Object} data Reaction data from the web service.\n */\nconst renderBar = async(postId, data) => {\n    const article = document.querySelector(`article[data-post-id=\"${postId}\"]`);\n    if (!article) {\n        return;\n    }\n\n    // Don't double-render.\n    if (article.querySelector('[data-region=\"reactions-bar\"]')) {\n        return;\n    }\n\n    const context = buildTemplateContext(data);\n\n    try {\n        const {html, js} = await Templates.renderForPromise('local_reactions/reactions_bar', context);\n        const container = document.createElement('div');\n        container.innerHTML = html;\n        const barElement = container.firstElementChild;\n\n        // Try to insert alongside the post actions (reply posts).\n        const actionsContainer = article.querySelector('[data-region=\"post-actions-container\"]');\n        if (actionsContainer) {\n            // Insert before the actions within the shared flex-wrap parent.\n            actionsContainer.parentElement.insertBefore(barElement, actionsContainer);\n        } else {\n            // Fallback for first post: append to the post core column.\n            const postCore = article.querySelector('[data-region-content=\"forum-post-core\"]');\n            if (!postCore) {\n                return;\n            }\n            postCore.appendChild(barElement);\n        }\n        Templates.runTemplateJS(js);\n\n        // Bind click handlers if the user can react.\n        if (config.canreact) {\n            bindClickHandlers(barElement, postId);\n        }\n    } catch (err) {\n        Notification.exception(err);\n    }\n};\n\n/**\n * Build Mustache template context from reaction data.\n *\n * @param {Object} data Reaction data.\n * @returns {Object} Template context.\n */\nconst buildTemplateContext = (data) => {\n    // Build a counts lookup.\n    const countsMap = {};\n    data.counts.forEach((c) => {\n        countsMap[c.emoji] = c.count;\n    });\n\n    // Build emoji buttons from the configured set.\n    const buttons = [];\n    for (const [shortcode, unicode] of Object.entries(config.emojis)) {\n        const count = countsMap[shortcode] || 0;\n        const isSelected = data.userreaction === shortcode;\n        buttons.push({\n            shortcode: shortcode,\n            unicode: unicode,\n            count: count,\n            hascount: count > 0,\n            selected: isSelected,\n            canreact: config.canreact,\n        });\n    }\n\n    return {\n        buttons: buttons,\n        canreact: config.canreact,\n    };\n};\n\n/**\n * Bind click handlers to emoji buttons within a reactions bar.\n *\n * @param {HTMLElement} barElement The reactions bar container.\n * @param {number} postId The forum post ID.\n */\nconst bindClickHandlers = (barElement, postId) => {\n    barElement.querySelectorAll('[data-action=\"toggle-reaction\"]').forEach((btn) => {\n        btn.addEventListener('click', async(e) => {\n            e.preventDefault();\n            const emoji = btn.getAttribute('data-emoji');\n            await toggleReaction(postId, emoji, barElement);\n        });\n    });\n};\n\n/**\n * Toggle a reaction via the web service and update the UI.\n *\n * @param {number} postId The forum post ID.\n * @param {string} emoji The emoji shortcode.\n * @param {HTMLElement} barElement The reactions bar to update.\n */\nconst toggleReaction = async(postId, emoji, barElement) => {\n    // Disable buttons while request is in flight.\n    const buttons = barElement.querySelectorAll('[data-action=\"toggle-reaction\"]');\n    buttons.forEach((b) => b.setAttribute('disabled', 'disabled'));\n\n    try {\n        const response = await Ajax.call([{\n            methodname: 'local_reactions_toggle_reaction',\n            args: {\n                component: config.component,\n                itemtype: config.itemtype,\n                itemid: postId,\n                emoji: emoji,\n            },\n        }])[0];\n\n        // Update the bar in-place.\n        updateBar(barElement, response);\n    } catch (err) {\n        Notification.exception(err);\n    } finally {\n        buttons.forEach((b) => b.removeAttribute('disabled'));\n    }\n};\n\n/**\n * Update the reactions bar UI after a toggle response.\n *\n * @param {HTMLElement} barElement The reactions bar container.\n * @param {Object} response Response from toggle_reaction WS.\n */\nconst updateBar = (barElement, response) => {\n    // Build counts lookup from response.\n    const countsMap = {};\n    response.counts.forEach((c) => {\n        countsMap[c.emoji] = c.count;\n    });\n\n    barElement.querySelectorAll('[data-action=\"toggle-reaction\"]').forEach((btn) => {\n        const shortcode = btn.getAttribute('data-emoji');\n        const count = countsMap[shortcode] || 0;\n        const isSelected = response.userreaction === shortcode;\n\n        // Update count display.\n        const countEl = btn.querySelector('[data-region=\"reaction-count\"]');\n        if (countEl) {\n            countEl.textContent = count > 0 ? count : '';\n        }\n\n        // Update selected state.\n        if (isSelected) {\n            btn.classList.add('local-reactions-selected');\n            btn.setAttribute('aria-pressed', 'true');\n        } else {\n            btn.classList.remove('local-reactions-selected');\n            btn.setAttribute('aria-pressed', 'false');\n        }\n\n        // Show/hide based on whether there's a count or user can react.\n        if (count > 0 || config.canreact) {\n            btn.classList.remove('local-reactions-empty');\n        } else {\n            btn.classList.add('local-reactions-empty');\n        }\n    });\n};\n"],"names":["config","cfg","loadReactions","observer","MutationObserver","mutations","mutation","node","addedNodes","nodeType","Node","ELEMENT_NODE","querySelector","container","document","observe","childList","subtree","async","articles","querySelectorAll","length","postIds","forEach","article","postId","parseInt","getAttribute","push","response","Ajax","call","methodname","args","component","itemtype","itemids","contextid","reactionsMap","items","item","itemid","data","userreaction","counts","renderBar","err","exception","context","buildTemplateContext","html","js","Templates","renderForPromise","createElement","innerHTML","barElement","firstElementChild","actionsContainer","parentElement","insertBefore","postCore","appendChild","runTemplateJS","canreact","bindClickHandlers","countsMap","c","emoji","count","buttons","shortcode","unicode","Object","entries","emojis","isSelected","hascount","selected","btn","addEventListener","e","preventDefault","toggleReaction","b","setAttribute","updateBar","removeAttribute","countEl","textContent","classList","add","remove"],"mappings":";;;;;;;4NA4BIA,OAAS,iBAYQC,MACjBD,OAASC,IACTC,sBAGMC,SAAW,IAAIC,kBAAkBC,gBAC9B,MAAMC,YAAYD,cACd,MAAME,QAAQD,SAASE,cACpBD,KAAKE,WAAaC,KAAKC,cAAgBJ,KAAKK,cAAc,qCAC1DV,mBAOVW,UAAYC,SAASF,cAAc,qCACrCC,WACAV,SAASY,QAAQF,UAAW,CAACG,WAAW,EAAMC,SAAS,WAOzDf,cAAgBgB,gBACZC,SAAWL,SAASM,iBAAiB,6BACtCD,SAASE,oBAKRC,QAAU,MAChBH,SAASI,SAASC,gBACRC,OAASC,SAASF,QAAQG,aAAa,iBACzCF,SAAWD,QAAQZ,cAAc,kCACjCU,QAAQM,KAAKH,WAIhBH,QAAQD,iBAKHQ,eAAiBC,cAAKC,KAAK,CAAC,CAC9BC,WAAY,gCACZC,KAAM,CACFC,UAAWlC,OAAOkC,UAClBC,SAAUnC,OAAOmC,SACjBC,QAASd,QACTe,UAAWrC,OAAOqC,cAEtB,GAGEC,aAAe,GACrBT,SAASU,MAAMhB,SAASiB,OACpBF,aAAaE,KAAKC,QAAUD,YAI3B,MAAMf,UAAUH,QAAS,OACpBoB,KAAOJ,aAAab,SAAW,CAACgB,OAAQhB,OAAQkB,aAAc,GAAIC,OAAQ,UAC1EC,UAAUpB,OAAQiB,OAE9B,MAAOI,2BACQC,UAAUD,OAUzBD,UAAY3B,MAAMO,OAAQiB,cACtBlB,QAAUV,SAASF,8CAAuCa,kBAC3DD,kBAKDA,QAAQZ,cAAc,8CAIpBoC,QAAUC,qBAAqBP,gBAG3BQ,KAACA,KAADC,GAAOA,UAAYC,mBAAUC,iBAAiB,gCAAiCL,SAC/EnC,UAAYC,SAASwC,cAAc,OACzCzC,UAAU0C,UAAYL,WAChBM,WAAa3C,UAAU4C,kBAGvBC,iBAAmBlC,QAAQZ,cAAc,6CAC3C8C,iBAEAA,iBAAiBC,cAAcC,aAAaJ,WAAYE,sBACrD,OAEGG,SAAWrC,QAAQZ,cAAc,+CAClCiD,gBAGLA,SAASC,YAAYN,+BAEfO,cAAcZ,IAGpBnD,OAAOgE,UACPC,kBAAkBT,WAAY/B,QAEpC,MAAOqB,2BACQC,UAAUD,OAUzBG,qBAAwBP,aAEpBwB,UAAY,GAClBxB,KAAKE,OAAOrB,SAAS4C,IACjBD,UAAUC,EAAEC,OAASD,EAAEE,eAIrBC,QAAU,OACX,MAAOC,UAAWC,WAAYC,OAAOC,QAAQ1E,OAAO2E,QAAS,OACxDN,MAAQH,UAAUK,YAAc,EAChCK,WAAalC,KAAKC,eAAiB4B,UACzCD,QAAQ1C,KAAK,CACT2C,UAAWA,UACXC,QAASA,QACTH,MAAOA,MACPQ,SAAUR,MAAQ,EAClBS,SAAUF,WACVZ,SAAUhE,OAAOgE,iBAIlB,CACHM,QAASA,QACTN,SAAUhE,OAAOgE,WAUnBC,kBAAoB,CAACT,WAAY/B,UACnC+B,WAAWpC,iBAAiB,mCAAmCG,SAASwD,MACpEA,IAAIC,iBAAiB,SAAS9D,MAAAA,IAC1B+D,EAAEC,uBACId,MAAQW,IAAIpD,aAAa,oBACzBwD,eAAe1D,OAAQ2C,MAAOZ,mBAY1C2B,eAAiBjE,MAAMO,OAAQ2C,MAAOZ,oBAElCc,QAAUd,WAAWpC,iBAAiB,mCAC5CkD,QAAQ/C,SAAS6D,GAAMA,EAAEC,aAAa,WAAY,wBAGxCxD,eAAiBC,cAAKC,KAAK,CAAC,CAC9BC,WAAY,kCACZC,KAAM,CACFC,UAAWlC,OAAOkC,UAClBC,SAAUnC,OAAOmC,SACjBM,OAAQhB,OACR2C,MAAOA,UAEX,GAGJkB,UAAU9B,WAAY3B,UACxB,MAAOiB,2BACQC,UAAUD,aAEvBwB,QAAQ/C,SAAS6D,GAAMA,EAAEG,gBAAgB,gBAU3CD,UAAY,CAAC9B,WAAY3B,kBAErBqC,UAAY,GAClBrC,SAASe,OAAOrB,SAAS4C,IACrBD,UAAUC,EAAEC,OAASD,EAAEE,SAG3Bb,WAAWpC,iBAAiB,mCAAmCG,SAASwD,YAC9DR,UAAYQ,IAAIpD,aAAa,cAC7B0C,MAAQH,UAAUK,YAAc,EAChCK,WAAa/C,SAASc,eAAiB4B,UAGvCiB,QAAUT,IAAInE,cAAc,kCAC9B4E,UACAA,QAAQC,YAAcpB,MAAQ,EAAIA,MAAQ,IAI1CO,YACAG,IAAIW,UAAUC,IAAI,4BAClBZ,IAAIM,aAAa,eAAgB,UAEjCN,IAAIW,UAAUE,OAAO,4BACrBb,IAAIM,aAAa,eAAgB,UAIjChB,MAAQ,GAAKrE,OAAOgE,SACpBe,IAAIW,UAAUE,OAAO,yBAErBb,IAAIW,UAAUC,IAAI"}