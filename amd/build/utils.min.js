define("local_reactions/utils",["exports","core/templates","local_reactions/cache"],(function(_exports,_templates,Cache){var obj;
/**
   * Shared utilities for emoji reactions modules.
   *
   * @module     local_reactions/utils
   * @copyright  2026 Andrew Rowatt <A.J.Rowatt@massey.ac.nz>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.updateCacheBatch=_exports.renderToElement=_exports.createPoller=_exports.computeDiffs=_exports.collectIds=_exports.clearAnimationClasses=_exports.buildTemplateContext=_exports.applyDiffAnimations=_exports.ANIMATION_TIMEOUT=void 0,_templates=(obj=_templates)&&obj.__esModule?obj:{default:obj},Cache=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(Cache);_exports.ANIMATION_TIMEOUT=2100;_exports.renderToElement=async(templateName,context)=>{const{html:html,js:js}=await _templates.default.renderForPromise(templateName,context),container=document.createElement("div");return container.innerHTML=html,{element:container.firstElementChild,js:js}};_exports.computeDiffs=(cachedData,freshData)=>{const cachedCounts={};((null==cachedData?void 0:cachedData.counts)||[]).forEach((c=>{cachedCounts[c.emoji]=c.count}));const freshCounts={};((null==freshData?void 0:freshData.counts)||[]).forEach((c=>{freshCounts[c.emoji]=c.count}));const changedEmojis=new Set,newEmojis=new Set,removedEmojis=new Set;for(const emoji of Object.keys(freshCounts))emoji in cachedCounts?freshCounts[emoji]!==cachedCounts[emoji]&&changedEmojis.add(emoji):freshCounts[emoji]>0&&newEmojis.add(emoji);for(const emoji of Object.keys(cachedCounts))cachedCounts[emoji]>0&&(!(emoji in freshCounts)||0===freshCounts[emoji])&&removedEmojis.add(emoji);return{hasChanges:changedEmojis.size>0||newEmojis.size>0||removedEmojis.size>0,changedEmojis:changedEmojis,newEmojis:newEmojis,removedEmojis:removedEmojis}};_exports.buildTemplateContext=function(data,emojis){let{canreact:canreact=!1,compactview:compactview=!1,userreactions:userreactions=[]}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const countsMap={};data.counts.forEach((c=>{countsMap[c.emoji]=c.count}));const buttons=[];let totalCount=0;const reactedEmojis=[];let hasAnySelected=!1;for(const[shortcode,unicode]of Object.entries(emojis)){const count=countsMap[shortcode]||0,isSelected=userreactions.includes(shortcode);buttons.push({shortcode:shortcode,unicode:unicode,count:count,hascount:count>0,selected:isSelected,canreact:canreact}),count>0&&(totalCount+=count,reactedEmojis.push({unicode:unicode}),isSelected&&(hasAnySelected=!0))}return{buttons:buttons,canreact:canreact,compactview:compactview,hasanycount:totalCount>0,totalcount:totalCount,reactedEmojis:reactedEmojis,selected:hasAnySelected}};_exports.createPoller=(intervalSeconds,pollFn)=>{if(!intervalSeconds||intervalSeconds<=0)return;let timer=setInterval(pollFn,1e3*intervalSeconds);document.addEventListener("visibilitychange",(()=>{document.hidden?timer&&(clearInterval(timer),timer=null):timer||(pollFn(),timer=setInterval(pollFn,1e3*intervalSeconds))}))};_exports.collectIds=(selector,attribute)=>{const ids=[];return document.querySelectorAll(selector).forEach((el=>{const id=parseInt(el.getAttribute(attribute));id&&ids.push(id)})),ids};_exports.applyDiffAnimations=(newBar,diffs,compactview)=>{if(diffs.hasChanges)if(compactview){const compactPill=newBar.querySelector(".local-reactions-pill-compact");compactPill&&compactPill.classList.add("local-reactions-count-changed")}else newBar.querySelectorAll("[data-emoji]").forEach((pill=>{const emoji=pill.getAttribute("data-emoji");diffs.changedEmojis.has(emoji)&&pill.classList.add("local-reactions-count-changed"),diffs.newEmojis.has(emoji)&&pill.classList.add("local-reactions-pill-new")}))};_exports.clearAnimationClasses=bar=>{setTimeout((()=>{bar.querySelectorAll(".local-reactions-count-changed, .local-reactions-pill-new").forEach((el=>{el.classList.remove("local-reactions-count-changed","local-reactions-pill-new")}))}),2100)};_exports.updateCacheBatch=async(ids,keyFn,dataMap)=>{if(!await Cache.isAvailable())return;const entries=[];for(const id of ids){const data=dataMap[id];data&&entries.push({key:keyFn(id),data:{counts:data.counts||[]}})}entries.length>0&&await Cache.setMultiple(entries)}}));

//# sourceMappingURL=utils.min.js.map